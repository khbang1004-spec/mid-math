-<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>중학교 수학 세부능력 특기사항 작성기 (ver.1)</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Noto+Sans+KR:wght@400;500;700;900&display=swap');
        body { font-family: 'Noto Sans KR', sans-serif; }
        .hidden { display: none; }
        .step-section { display: none; }
        .step-section.active { display: block; }
        @keyframes slideIn {
          from { transform: translateY(20px); opacity: 0; }
          to { transform: translateY(0); opacity: 1; }
        }
        .animate-slideIn { animation: slideIn 0.5s ease-out forwards; }
    </style>
</head>
<body class="bg-gray-50">

    <div id="app-wrapper" class="max-w-6xl mx-auto p-6 min-h-screen">

        <!-- 로그인 화면 -->
        <div id="login-container" class="flex flex-col items-center justify-center min-h-[80vh]">
            <div class="text-center p-8 bg-white rounded-2xl shadow-xl border border-gray-200">
                <h1 class="text-5xl font-extrabold text-gray-800 mb-4">중학교 수학 세특 작성기</h1>
                <p class="text-2xl text-gray-600 mb-12">(ver.1)</p>
                <button id="login-btn" class="bg-white hover:bg-gray-100 text-gray-800 font-semibold py-3 px-8 border border-gray-300 rounded-lg shadow-md transition transform hover:scale-105 flex items-center gap-3 mx-auto">
                    <svg class="w-6 h-6" viewBox="0 0 48 48"><path fill="#4285F4" d="M43.611 20.083H42V20H24v8h11.303c-1.649 4.657-6.08 8-11.303 8c-6.627 0-12-5.373-12-12s5.373-12 12-12c3.059 0 5.842 1.154 7.961 3.039l5.657-5.657C34.046 6.053 29.268 4 24 4C12.955 4 4 12.955 4 24s8.955 20 20 20s20-8.955 20-20c0-1.341-.138-2.65-.389-3.917z"></path><path fill="#34A853" d="M43.611 20.083H42V20H24v8h11.303c-1.649 4.657-6.08 8-11.303 8V44c5.268 0 10.046-1.947 13.611-5.657c3.565-3.71 5.657-8.857 5.657-14.343c0-1.341-.138-2.65-.389-3.917z"></path><path fill="#FBBC05" d="M9.961 16.304A11.945 11.945 0 0 0 8 24c0 1.575.293 3.083.824 4.47l-5.657 5.657A19.93 19.93 0 0 1 0 24c0-4.93 1.805-9.42 4.78-12.923l5.181 9.227z"></path><path fill="#EA4335" d="M24 8c-3.059 0-5.842 1.154-7.961 3.039l-5.657-5.657C13.954 1.947 18.732 0 24 0c5.268 0 10.046 1.947 13.611 5.657L32 11.314A11.962 11.962 0 0 0 24 8z"></path></svg>
                    Google 계정으로 로그인
                </button>
            </div>
        </div>

        <!-- 메인 앱 컨텐츠 -->
        <div id="app-container" class="hidden">
            <div id="toast-container" class="fixed top-4 right-4 z-50 space-y-2"></div>
            <div id="modal-container"></div>
            
            <header class="flex justify-between items-start mb-8">
                <div>
                    <h1 class="text-4xl font-extrabold text-gray-900 mb-2">중학교 수학 세부능력 특기사항 작성기</h1>
                    <p class="text-lg text-gray-600">(ver.1)</p>
                </div>
                <div id="user-profile" class="flex items-center gap-4">
                    <!-- 사용자 정보 및 로그아웃 버튼이 여기에 표시됩니다. -->
                </div>
            </header>
            
            <main class="main-content">
                <div id="stepper" class="mb-10">
                    <!-- Stepper will be injected here by JavaScript -->
                </div>

                <div class="bg-white p-8 rounded-2xl shadow-xl border border-gray-200">
                    <div id="step-1" class="step-section active"></div>
                    <div id="step-2" class="step-section"></div>
                    <div id="step-3" class="step-section"></div>
                    <div id="step-4" class="step-section"></div>
                </div>

                <div class="flex justify-between mt-8">
                    <button id="prev-step-btn" class="flex items-center gap-2 px-6 py-3 rounded-md text-gray-600 border border-gray-300 shadow-sm hover:bg-gray-100 disabled:opacity-50 disabled:cursor-not-allowed transition">
                        <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><polyline points="15 18 9 12 15 6"/></svg>
                        이전
                    </button>
                    <button id="next-step-btn" class="flex items-center gap-2 px-6 py-3 rounded-md bg-blue-600 text-white shadow-sm hover:bg-blue-700 disabled:opacity-50 disabled:cursor-not-allowed transition">
                        다음
                        <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><polyline points="9 18 15 12 9 6"/></svg>
                    </button>
                </div>
            </main>
        </div>
    </div>

    <script type="module">
        // Firebase SDK Imports
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, GoogleAuthProvider, signInWithPopup, signOut, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        
        // --- Firebase Configuration ---
        const firebaseConfig = {
            apiKey: "AIzaSyBzav3lUsC6YGdrKdGcH-EVsydj1LPPfws",
            authDomain: "mid-math.firebaseapp.com",
            projectId: "mid-math",
            storageBucket: "mid-math.appspot.com",
            messagingSenderId: "485668916042",
            appId: "1:485668916042:web:d7c989e020671bc36c4fb3",
            measurementId: "G-V3YJR7X29Z"
        };

        // Initialize Firebase
        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const provider = new GoogleAuthProvider();

        // --- DOM Elements ---
        const loginContainer = document.getElementById('login-container');
        const appContainer = document.getElementById('app-container');
        const loginBtn = document.getElementById('login-btn');
        const userProfileContainer = document.getElementById('user-profile');

        // --- Authentication Logic ---
        const signInWithGoogle = async () => {
            try {
                await signInWithPopup(auth, provider);
            } catch (error) {
                console.error("Google 로그인 중 오류 발생:", error);
                showToast('로그인 중 오류가 발생했습니다.', 'error');
            }
        };

        const signOutUser = async () => {
            try {
                await signOut(auth);
            } catch (error) {
                console.error("로그아웃 중 오류 발생:", error);
                showToast('로그아웃 중 오류가 발생했습니다.', 'error');
            }
        };

        // --- UI Control based on Auth State ---
        onAuthStateChanged(auth, (user) => {
            if (user) {
                // Logged In
                loginContainer.classList.add('hidden');
                appContainer.classList.remove('hidden');
                appContainer.classList.add('animate-slideIn');

                userProfileContainer.innerHTML = `
                    <span class="font-semibold text-gray-700">${user.displayName}님</span>
                    <img src="${user.photoURL}" alt="프로필 사진" class="w-10 h-10 rounded-full border-2 border-gray-300">
                    <button id="logout-btn" class="px-4 py-2 bg-red-500 text-white text-sm rounded-md shadow-sm hover:bg-red-600 transition">로그아웃</button>
                `;
                document.getElementById('logout-btn').addEventListener('click', signOutUser);
                
                // Initialize the main app
                initializeAppLogic();

            } else {
                // Logged Out
                appContainer.classList.add('hidden');
                loginContainer.classList.remove('hidden');
                userProfileContainer.innerHTML = '';
            }
        });
        
        // --- Main App Logic (기존 코드) ---
        
        // Global state object
        const state = {
            currentStep: 1,
            students: [],
            studentInput: '',
            selectedGrade: '',
            selectedUnits: [],
            stagedStudentAchievements: {},
            generatedRecords: {},
            isLoading: false,
            guidelines: { include: '', exclude: '' },
            maxByteCount: 1000,
            achievementsPerStudent: 3,
        };
        
        const unitAchievements = {
          '중1': {
            '소인수분해': [{ code: '9수01-01', content: '소인수분해를 이용하여 최대공약수와 최소공배수를 구할 수 있다.' }, { code: '9수01-02', content: '정수와 유리수의 개념을 이해하고, 수의 대소 관계를 비교할 수 있다.' }],
            '정수와 유리수': [{ code: '9수01-03', content: '정수와 유리수의 덧셈과 뺄셈의 원리를 이해하고 계산할 수 있다.' }, { code: '9수01-04', content: '정수와 유리수의 곱셈과 나눗셈의 원리를 이해하고 계산할 수 있다.' }, { code: '9수01-05', content: '정수와 유리수의 사칙연산이 혼합된 계산의 순서를 알고 계산할 수 있다.' }],
            '문자의 사용과 식': [{ code: '9수02-01', content: '문자를 사용하여 식을 간단히 나타낼 수 있다.' }, { code: '9수02-02', content: '단항식의 곱셈과 나눗셈의 원리를 이해하고 계산할 수 있다.' }],
            '일차방정식': [{ code: '9수02-03', content: '일차방정식의 개념과 풀이 방법을 이해하고 문제를 해결할 수 있다.' }, { code: '9수02-04', content: '일차방정식을 활용하여 다양한 실생활 문제를 해결할 수 있다.' }],
            '좌표평면과 그래프': [{ code: '9수02-05', content: '좌표평면 위의 점의 좌표를 이해하고, 이를 이용하여 문제를 해결할 수 있다.' }, { code: '9수02-06', content: '정비례 관계의 의미를 알고, 그 그래프를 그릴 수 있다.' }, { code: '9수02-07', content: '반비례 관계의 의미를 알고, 그 그래프를 그릴 수 있다.' }],
            '기본도형': [{ code: '9수03-01', content: '점, 선, 면의 관계를 이해하고, 다양한 기본 도형을 관찰하여 문제를 해결할 수 있다.' }, { code: '9수03-02', content: '각의 개념을 이해하고, 평행선의 성질을 활용하여 문제를 해결할 수 있다.' }],
            '작도와 합동': [{ code: '9수03-03', content: '삼각형의 작도와 합동의 원리를 이해하고, 이를 활용하여 문제를 해결할 수 있다.' }, { code: '9수03-04', content: '평행선과 엇각, 동위각의 성질을 이해하고, 이를 도형의 성질 증명에 활용할 수 있다.' }],
            '평면도형의 성질': [{ code: '9수03-05', content: '다각형의 성질을 이해하고, 내각과 외각의 크기를 구할 수 있다.' }, { code: '9수03-06', content: '원과 부채꼴의 성질을 이해하고, 호의 길이와 넓이를 계산할 수 있다.' }],
            '입체도형의 성질': [{ code: '9수03-07', content: '다양한 입체도형의 특징을 이해하고, 겉넓이와 부피를 구할 수 있다.' }, { code: '9수03-08', content: '회전체와 단면의 특징을 이해하고, 이를 활용하여 문제를 해결할 수 있다.' }],
            '대푯값': [{ code: '9수04-01', content: '도수분포표, 히스토그램, 도수분포다각형을 이해하고 작성할 수 있다.' }, { code: '9수04-02', content: '자료를 막대그래프, 원그래프 등으로 나타내고 해석할 수 있다.' }, { code: '9수04-03', content: '상대도수의 개념을 이해하고, 이를 활용하여 문제를 해결할 수 있다.' }, { code: '9수04-04', content: '자료를 수집하고 정리하여 경향성을 파악할 수 있다.' }],
          },
          '중2': {
            '유리수와 순환소수': [{ code: '9수01-06', content: '유리수와 순환소수의 관계를 이해하고, 이를 구분할 수 있다.' }],
            '식의 계산': [{ code: '9수02-08', content: '단항식과 다항식의 곱셈과 나눗셈을 할 수 있다.' }, { code: '9수02-09', content: '다항식의 덧셈과 뺄셈의 원리를 이해하고 계산할 수 있다.' }, { code: '9수02-10', content: '등식의 성질을 이해하고, 일차방정식의 풀이에 적용할 수 있다.' }],
            '일차부등식': [{ code: '9수02-11', content: '일차부등식의 의미와 풀이 방법을 이해하고, 수직선에 나타낼 수 있다.' }, { code: '9수02-12', content: '연립일차부등식을 풀고, 해를 수직선 위에 나타낼 수 있다.' }],
            '연립일차방정식': [{ code: '9수02-13', content: '연립일차방정식의 해를 구할 수 있고, 이를 활용하여 문제를 해결할 수 있다.' }],
            '일차함수와 그 그래프': [{ code: '9수02-14', content: '일차함수의 의미를 이해하고, 그 그래프를 그릴 수 있다.' }, { code: '9수02-15', content: '일차함수의 그래프의 기울기와 y절편의 의미를 이해하고, 그래프의 성질을 설명할 수 있다.' }, { code: '9수02-16', content: '일차함수의 그래프의 평행이동과 대칭이동을 이해하고, 그래프를 그릴 수 있다.' }],
            '일차함수와 일차방정식의 관계': [{ code: '9수02-17', content: '일차함수와 일차방정식의 관계를 이해하고, 그래프를 활용하여 문제를 해결할 수 있다.' }, { code: '9수02-18', content: '연립일차방정식의 해를 일차함수의 그래프를 이용하여 구할 수 있다.' }],
            '삼각형과 사각형의 성질': [{ code: '9수03-09', content: '삼각형의 내각과 외각의 성질을 이해하고, 이를 활용하여 문제를 해결할 수 있다.' }, { code: '9수03-10', content: '이등변삼각형의 성질을 이해하고, 이를 증명할 수 있다.' }, { code: '9수03-11', content: '직각삼각형의 합동조건을 이해하고, 이를 활용하여 문제를 해결할 수 있다.' }],
            '도형의 닮음': [{ code: '9수03-12', content: '도형의 닮음의 개념을 이해하고, 닮음비를 구할 수 있다.' }, { code: '9수03-13', content: '삼각형의 닮음조건을 이해하고, 이를 활용하여 문제를 해결할 수 있다.' }, { code: '9수03-14', content: '피타고라스 정리를 이해하고, 이를 증명할 수 있다.' }],
            '피타고라스 정리': [{ code: '9수03-15', content: '피타고라스 정리를 이해하고, 이를 증명할 수 있다.' }],
            '경우의 수와 확률': [{ code: '9수04-05', content: '경우의 수의 개념을 이해하고, 합의 법칙과 곱의 법칙을 활용할 수 있다.' }, { code: '9수04-06', content: '확률의 개념과 기본 성질을 이해하고, 이를 활용하여 문제를 해결할 수 있다.' }],
          },
          '중3': {
            '제곱근과 실수': [{ code: '9수01-07', content: '제곱근의 의미를 이해하고, 제곱근을 구할 수 있다.' }, { code: '9수01-08', content: '무리수와 실수의 개념을 이해하고, 실수의 대소 관계를 비교할 수 있다.' }, { code: '9수01-09', content: '제곱근의 곱셈과 나눗셈을 할 수 있다.' }, { code: '9수01-10', content: '제곱근의 덧셈과 뺄셈을 할 수 있다.' }],
            '다항식의 곱셈과 인수분해': [{ code: '9수02-19', content: '이차식의 인수분해의 원리를 이해하고, 이를 활용하여 문제를 해결할 수 있다.' }, { code: '9수02-20', content: '이차방정식의 의미를 이해하고, 그 해를 구할 수 있다.' }],
            '이차함수와 그 그래프': [{ code: '9수02-21', content: '이차함수의 의미를 이해하고, 그 그래프를 그릴 수 있다.' }, { code: '9수02-22', content: '이차함수 $y=ax^2+bx+c$ 의 그래프의 성질을 이해하고, 이를 활용할 수 있다.' }],
            '삼각비': [{ code: '9수03-16', content: '삼각비의 뜻을 알고, 직각삼각형에서 삼각비의 값을 구할 수 있다.' }, { code: '9수03-17', content: '삼각비를 활용하여 실생활 문제를 해결할 수 있다.' }],
            '원의 성질': [{ code: '9수03-18', content: '원의 현과 접선의 성질을 이해하고, 이를 활용하여 문제를 해결할 수 있다.' }, { code: '9수03-19', content: '원주각의 성질을 이해하고, 원주각의 크기를 구할 수 있다.' }],
            '산포도': [{ code: '9수04-07', content: '대푯값의 의미를 이해하고, 평균, 중앙값, 최빈값을 구할 수 있다.' }, { code: '9수04-08', content: '산포도의 의미를 이해하고, 분산과 표준편차를 구할 수 있다.' }, { code: '9수04-09', content: '산점도와 상관관계를 이해하고, 이를 분석할 수 있다.' }],
          },
        };

        const allAchievements = Object.values(unitAchievements).flatMap(grade => Object.values(grade)).flat();
        
        // Helper functions
        const getByteCount = (str) => new TextEncoder().encode(str).length;
        const truncateBySentence = (text, maxBytes) => {
            if (getByteCount(text) <= maxBytes) return text;
            const sentences = text.match(/[^.!?]*[.!?]\s*/g) || [text];
            let truncatedText = '';
            let currentBytes = 0;
            for (const sentence of sentences) {
                const sentenceBytes = getByteCount(sentence);
                if (currentBytes + sentenceBytes > maxBytes) break;
                truncatedText += sentence;
                currentBytes += sentenceBytes;
            }
            if (truncatedText.length === 0 && text.length > 0) {
                const encoder = new TextEncoder();
                const decoder = new TextDecoder('utf-8');
                truncatedText = decoder.decode(encoder.encode(text).slice(0, maxBytes));
            }
            if (truncatedText.length > 0 && !/[.!?]$/.test(truncatedText.trim())) {
                truncatedText = truncatedText.trim() + '.';
            }
            return truncatedText.trim();
        };
        const showToast = (message, type = 'success') => { /* ... */ };

        // DOM rendering functions
        const renderApp = () => {
            renderStepper();
            renderStepContent();
            updateNavButtons();
        };

        const renderStepper = () => {
            const stepperContainer = document.getElementById('stepper');
            const steps = [
                { number: 1, title: '학년 및 학생 명단', icon: `<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M16 21v-2a4 4 0 0 0-4-4H6a4 4 0 0 0-4 4v2"/><circle cx="9" cy="7" r="4"/><path d="M22 21v-2a4 4 0 0 0-3-3.87"/><path d="M16 3.13a4 4 0 0 1 0 7.75"/></svg>` },
                { number: 2, title: '단원 선택', icon: `<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M4 19.5v-15A2.5 2.5 0 0 1 6.5 2H20v20H6.5a2.5 2.5 0 0 1 0-5H20"/><path d="m9 9.5 2 2 4-4"/></svg>` },
                { number: 3, title: '성취기준 배정', icon: `<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><rect width="18" height="18" x="3" y="3" rx="2"/><path d="m9 12 2 2 4-4"/></svg>` },
                { number: 4, title: '특기사항 생성', icon: `<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M15 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V7Z"/><path d="M14 2v4a2 2 0 0 0 2 2h4"/><path d="M10 9H8"/><path d="M16 13H8"/><path d="M16 17H8"/></svg>` },
            ];
            stepperContainer.innerHTML = `
                <div class="flex items-center justify-between">
                    ${steps.map(step => `
                        <div class="flex-1 min-w-0 flex flex-col items-center cursor-pointer" onclick="window.goToStep(${step.number})">
                            <div class="flex items-center justify-center w-12 h-12 rounded-full shadow-lg ${state.currentStep >= step.number ? 'bg-blue-600 text-white' : 'bg-gray-200 text-gray-600'} transition-colors duration-300">
                                ${step.icon}
                            </div>
                            <div class="mt-2 text-sm font-semibold transition-colors duration-300 ${state.currentStep === step.number ? 'text-blue-600' : 'text-gray-500'}">STEP ${step.number}</div>
                            <div class="mt-1 text-xs text-center transition-colors duration-300 ${state.currentStep === step.number ? 'text-gray-800 font-bold' : 'text-gray-500'}">${step.title}</div>
                        </div>
                    `).join('')}
                </div>
            `;
        };
        
        const renderStepContent = () => {
            document.querySelectorAll('.step-section').forEach(el => el.classList.remove('active'));
            const activeStepEl = document.getElementById(`step-${state.currentStep}`);
            if (activeStepEl) {
                activeStepEl.classList.add('active');
                switch(state.currentStep) {
                    case 1: renderStep1(); break;
                    case 2: renderStep2(); break;
                    case 3: renderStep3(); break;
                    case 4: renderStep4(); break;
                }
            }
        };

        const renderStep1 = () => {
            const container = document.getElementById('step-1');
            container.innerHTML = `
                <div class="space-y-6">
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">학년 선택</label>
                        <select id="grade-select" class="w-full p-3 border border-gray-300 rounded-md shadow-sm focus:border-blue-500 focus:ring focus:ring-blue-500 focus:ring-opacity-50 transition">
                            <option value="">학년을 선택하세요</option>
                            <option value="중1" ${state.selectedGrade === '중1' ? 'selected' : ''}>중1</option>
                            <option value="중2" ${state.selectedGrade === '중2' ? 'selected' : ''}>중2</option>
                            <option value="중3" ${state.selectedGrade === '중3' ? 'selected' : ''}>중3</option>
                        </select>
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">학생 명단 입력</label>
                        <div class="space-y-3">
                            <textarea id="student-input" placeholder="김철수\n이영희\n박민수" class="w-full h-32 p-3 border border-gray-300 rounded-md shadow-sm focus:border-blue-500 focus:ring focus:ring-blue-500 focus:ring-opacity-50 transition">${state.studentInput}</textarea>
                            <button id="register-students-btn" class="w-full px-4 py-2 bg-blue-600 text-white rounded-md shadow-md hover:bg-blue-700 transition">명단 등록</button>
                        </div>
                        <div class="border-t pt-3 mt-3">
                            <label class="text-sm text-gray-600 block mb-2">CSV 파일 업로드 (이름)</label>
                            <input type="file" id="csv-upload" accept=".csv" class="block w-full text-sm text-gray-500 file:mr-4 file:py-2 file:px-4 file:rounded-md file:border-0 file:text-sm file:font-medium file:bg-blue-50 file:text-blue-700 hover:file:bg-blue-100 cursor-pointer" />
                            <p class="text-xs text-gray-500 mt-1">CSV 형식: 이름</p>
                        </div>
                    </div>
                    ${state.students.length > 0 ? `
                        <div class="bg-green-50 p-4 rounded-md shadow-sm">
                            <h3 class="font-medium text-green-800">등록된 학생 (${state.students.length}명)</h3>
                            <div class="mt-2 flex flex-wrap gap-2">
                                ${state.students.map(student => `<span class="px-2 py-1 bg-green-200 text-green-800 rounded-lg text-sm font-medium">${student.name}</span>`).join('')}
                            </div>
                        </div>
                    ` : ''}
                </div>
            `;
            document.getElementById('grade-select').addEventListener('change', (e) => { state.selectedGrade = e.target.value; });
            document.getElementById('student-input').addEventListener('input', (e) => { state.studentInput = e.target.value; });
            document.getElementById('register-students-btn').addEventListener('click', handleStudentInput);
            document.getElementById('csv-upload').addEventListener('change', handleFileUpload);
        };
        
        const renderStep2 = () => { /* ... */ };
        const renderStep3 = () => { /* ... */ };
        const renderStep4 = () => { /* ... */ };
        const renderRecordsOutput = () => { /* ... */ };
        const addRecordOutputListeners = () => { /* ... */ };
        const updateNavButtons = () => { /* ... */ };
        
        // Event Handlers & Logic
        const handleStudentInput = () => { /* ... */ };
        const handleFileUpload = async (event) => { /* ... */ };
        const toggleUnit = (unit) => { /* ... */ };
        const handleAchievementToggle = (studentId, code) => { /* ... */ };
        const autoAssignAchievements = () => { /* ... */ };
        const generateRecords = async () => { /* ... */ };
        const updateGenerateButton = (isLoading, text) => { /* ... */ };
        
        // Navigation
        window.goToStep = (stepNumber) => {
            state.currentStep = stepNumber;
            renderApp();
        };
        const nextStep = () => {
            if (state.currentStep < 4) {
                state.currentStep++;
                renderApp();
            }
        };
        const prevStep = () => {
            if (state.currentStep > 1) {
                state.currentStep--;
                renderApp();
            }
        };
        
        // --- App Initialization ---
        function initializeAppLogic() {
            // This function sets up the main application logic and event listeners
            // It's called only after a successful login.
            document.getElementById('prev-step-btn').addEventListener('click', prevStep);
            document.getElementById('next-step-btn').addEventListener('click', nextStep);
            renderApp();
        }

        // Initial listener for the login button
        loginBtn.addEventListener('click', signInWithGoogle);

    </script>
</body>
</html>
