<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>중학교 수학 세부능력 특기사항 작성기 (ver.1)</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Noto+Sans+KR:wght@400;500;700;900&display=swap');
        body { font-family: 'Noto Sans KR', sans-serif; }
        .step-section { display: none; }
        .step-section.active { display: block; }
        @keyframes slideIn {
          from { transform: translateY(100%); opacity: 0; }
          to { transform: translateY(0); opacity: 1; }
        }
        .animate-slideIn { animation: slideIn 0.5s ease-out; }
    </style>
</head>
<body class="bg-gray-50">
    <div id="app-container" class="font-sans max-w-6xl mx-auto p-6 min-h-screen">
        <div id="toast-container" class="fixed top-4 right-4 z-50 space-y-2"></div>
        <div id="modal-container"></div>

        <div class="flex justify-between items-start mb-8">
            <div>
                <h1 class="text-4xl font-extrabold text-gray-900 mb-2">중학교 수학 세부능력 특기사항 작성기</h1>
                <p class="text-lg text-gray-600">(ver.1)</p>
            </div>
        </div>
        
        <div class="main-content">
            <div id="stepper" class="mb-10">
                <!-- Stepper will be injected here by JavaScript -->
            </div>

            <div class="bg-white p-8 rounded-2xl shadow-xl border border-gray-200">
                <div id="step-1" class="step-section active"></div>
                <div id="step-2" class="step-section"></div>
                <div id="step-3" class="step-section"></div>
                <div id="step-4" class="step-section"></div>
            </div>

            <div class="flex justify-between mt-8">
                <button id="prev-step-btn" class="flex items-center gap-2 px-6 py-3 rounded-md text-gray-600 border border-gray-300 shadow-sm hover:bg-gray-100 disabled:opacity-50 disabled:cursor-not-allowed transition">
                    <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><polyline points="15 18 9 12 15 6"/></svg>
                    이전
                </button>
                <button id="next-step-btn" class="flex items-center gap-2 px-6 py-3 rounded-md bg-blue-600 text-white shadow-sm hover:bg-blue-700 disabled:opacity-50 disabled:cursor-not-allowed transition">
                    다음
                    <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><polyline points="9 18 15 12 9 6"/></svg>
                </button>
            </div>
        </div>
    </div>

    <script type="module">
        // Global state object
        const state = {
            currentStep: 1,
            students: [],
            studentInput: '',
            selectedGrade: '',
            selectedUnits: [],
            stagedStudentAchievements: {},
            generatedRecords: {},
            isLoading: false,
            guidelines: { include: '', exclude: '' },
            maxByteCount: 1000,
            achievementsPerStudent: 3,
        };
        
        const unitAchievements = {
          '중1': {
            '소인수분해': [{ code: '9수01-01', content: '소인수분해를 이용하여 최대공약수와 최소공배수를 구할 수 있다.' }, { code: '9수01-02', content: '정수와 유리수의 개념을 이해하고, 수의 대소 관계를 비교할 수 있다.' }],
            '정수와 유리수': [{ code: '9수01-03', content: '정수와 유리수의 덧셈과 뺄셈의 원리를 이해하고 계산할 수 있다.' }, { code: '9수01-04', content: '정수와 유리수의 곱셈과 나눗셈의 원리를 이해하고 계산할 수 있다.' }, { code: '9수01-05', content: '정수와 유리수의 사칙연산이 혼합된 계산의 순서를 알고 계산할 수 있다.' }],
            '문자의 사용과 식': [{ code: '9수02-01', content: '문자를 사용하여 식을 간단히 나타낼 수 있다.' }, { code: '9수02-02', content: '단항식의 곱셈과 나눗셈의 원리를 이해하고 계산할 수 있다.' }],
            '일차방정식': [{ code: '9수02-03', content: '일차방정식의 개념과 풀이 방법을 이해하고 문제를 해결할 수 있다.' }, { code: '9수02-04', content: '일차방정식을 활용하여 다양한 실생활 문제를 해결할 수 있다.' }],
            '좌표평면과 그래프': [{ code: '9수02-05', content: '좌표평면 위의 점의 좌표를 이해하고, 이를 이용하여 문제를 해결할 수 있다.' }, { code: '9수02-06', content: '정비례 관계의 의미를 알고, 그 그래프를 그릴 수 있다.' }, { code: '9수02-07', content: '반비례 관계의 의미를 알고, 그 그래프를 그릴 수 있다.' }],
            '기본도형': [{ code: '9수03-01', content: '점, 선, 면의 관계를 이해하고, 다양한 기본 도형을 관찰하여 문제를 해결할 수 있다.' }, { code: '9수03-02', content: '각의 개념을 이해하고, 평행선의 성질을 활용하여 문제를 해결할 수 있다.' }],
            '작도와 합동': [{ code: '9수03-03', content: '삼각형의 작도와 합동의 원리를 이해하고, 이를 활용하여 문제를 해결할 수 있다.' }, { code: '9수03-04', content: '평행선과 엇각, 동위각의 성질을 이해하고, 이를 도형의 성질 증명에 활용할 수 있다.' }],
            '평면도형의 성질': [{ code: '9수03-05', content: '다각형의 성질을 이해하고, 내각과 외각의 크기를 구할 수 있다.' }, { code: '9수03-06', content: '원과 부채꼴의 성질을 이해하고, 호의 길이와 넓이를 계산할 수 있다.' }],
            '입체도형의 성질': [{ code: '9수03-07', content: '다양한 입체도형의 특징을 이해하고, 겉넓이와 부피를 구할 수 있다.' }, { code: '9수03-08', content: '회전체와 단면의 특징을 이해하고, 이를 활용하여 문제를 해결할 수 있다.' }],
            '대푯값': [{ code: '9수04-01', content: '도수분포표, 히스토그램, 도수분포다각형을 이해하고 작성할 수 있다.' }, { code: '9수04-02', content: '자료를 막대그래프, 원그래프 등으로 나타내고 해석할 수 있다.' }, { code: '9수04-03', content: '상대도수의 개념을 이해하고, 이를 활용하여 문제를 해결할 수 있다.' }, { code: '9수04-04', content: '자료를 수집하고 정리하여 경향성을 파악할 수 있다.' }],
          },
          '중2': {
            '유리수와 순환소수': [{ code: '9수01-06', content: '유리수와 순환소수의 관계를 이해하고, 이를 구분할 수 있다.' }],
            '식의 계산': [{ code: '9수02-08', content: '단항식과 다항식의 곱셈과 나눗셈을 할 수 있다.' }, { code: '9수02-09', content: '다항식의 덧셈과 뺄셈의 원리를 이해하고 계산할 수 있다.' }, { code: '9수02-10', content: '등식의 성질을 이해하고, 일차방정식의 풀이에 적용할 수 있다.' }],
            '일차부등식': [{ code: '9수02-11', content: '일차부등식의 의미와 풀이 방법을 이해하고, 수직선에 나타낼 수 있다.' }, { code: '9수02-12', content: '연립일차부등식을 풀고, 해를 수직선 위에 나타낼 수 있다.' }],
            '연립일차방정식': [{ code: '9수02-13', content: '연립일차방정식의 해를 구할 수 있고, 이를 활용하여 문제를 해결할 수 있다.' }],
            '일차함수와 그 그래프': [{ code: '9수02-14', content: '일차함수의 의미를 이해하고, 그 그래프를 그릴 수 있다.' }, { code: '9수02-15', content: '일차함수의 그래프의 기울기와 y절편의 의미를 이해하고, 그래프의 성질을 설명할 수 있다.' }, { code: '9수02-16', content: '일차함수의 그래프의 평행이동과 대칭이동을 이해하고, 그래프를 그릴 수 있다.' }],
            '일차함수와 일차방정식의 관계': [{ code: '9수02-17', content: '일차함수와 일차방정식의 관계를 이해하고, 그래프를 활용하여 문제를 해결할 수 있다.' }, { code: '9수02-18', content: '연립일차방정식의 해를 일차함수의 그래프를 이용하여 구할 수 있다.' }],
            '삼각형과 사각형의 성질': [{ code: '9수03-09', content: '삼각형의 내각과 외각의 성질을 이해하고, 이를 활용하여 문제를 해결할 수 있다.' }, { code: '9수03-10', content: '이등변삼각형의 성질을 이해하고, 이를 증명할 수 있다.' }, { code: '9수03-11', content: '직각삼각형의 합동조건을 이해하고, 이를 활용하여 문제를 해결할 수 있다.' }],
            '도형의 닮음': [{ code: '9수03-12', content: '도형의 닮음의 개념을 이해하고, 닮음비를 구할 수 있다.' }, { code: '9수03-13', content: '삼각형의 닮음조건을 이해하고, 이를 활용하여 문제를 해결할 수 있다.' }, { code: '9수03-14', content: '피타고라스 정리를 이해하고, 이를 증명할 수 있다.' }],
            '피타고라스 정리': [{ code: '9수03-15', content: '피타고라스 정리를 이해하고, 이를 증명할 수 있다.' }],
            '경우의 수와 확률': [{ code: '9수04-05', content: '경우의 수의 개념을 이해하고, 합의 법칙과 곱의 법칙을 활용할 수 있다.' }, { code: '9수04-06', content: '확률의 개념과 기본 성질을 이해하고, 이를 활용하여 문제를 해결할 수 있다.' }],
          },
          '중3': {
            '제곱근과 실수': [{ code: '9수01-07', content: '제곱근의 의미를 이해하고, 제곱근을 구할 수 있다.' }, { code: '9수01-08', content: '무리수와 실수의 개념을 이해하고, 실수의 대소 관계를 비교할 수 있다.' }, { code: '9수01-09', content: '제곱근의 곱셈과 나눗셈을 할 수 있다.' }, { code: '9수01-10', content: '제곱근의 덧셈과 뺄셈을 할 수 있다.' }],
            '다항식의 곱셈과 인수분해': [{ code: '9수02-19', content: '이차식의 인수분해의 원리를 이해하고, 이를 활용하여 문제를 해결할 수 있다.' }, { code: '9수02-20', content: '이차방정식의 의미를 이해하고, 그 해를 구할 수 있다.' }],
            '이차함수와 그 그래프': [{ code: '9수02-21', content: '이차함수의 의미를 이해하고, 그 그래프를 그릴 수 있다.' }, { code: '9수02-22', content: '이차함수 $y=ax^2+bx+c$ 의 그래프의 성질을 이해하고, 이를 활용할 수 있다.' }],
            '삼각비': [{ code: '9수03-16', content: '삼각비의 뜻을 알고, 직각삼각형에서 삼각비의 값을 구할 수 있다.' }, { code: '9수03-17', content: '삼각비를 활용하여 실생활 문제를 해결할 수 있다.' }],
            '원의 성질': [{ code: '9수03-18', content: '원의 현과 접선의 성질을 이해하고, 이를 활용하여 문제를 해결할 수 있다.' }, { code: '9수03-19', content: '원주각의 성질을 이해하고, 원주각의 크기를 구할 수 있다.' }],
            '산포도': [{ code: '9수04-07', content: '대푯값의 의미를 이해하고, 평균, 중앙값, 최빈값을 구할 수 있다.' }, { code: '9수04-08', content: '산포도의 의미를 이해하고, 분산과 표준편차를 구할 수 있다.' }, { code: '9수04-09', content: '산점도와 상관관계를 이해하고, 이를 분석할 수 있다.' }],
          },
        };
        const getByteCount = (str) => new TextEncoder().encode(str).length;
        const truncateBySentence = (text, maxBytes) => {
            if (getByteCount(text) <= maxBytes) return text;
            const sentences = text.match(/[^.!?]*[.!?]\s*/g) || [text];
            let truncatedText = '';
            let currentBytes = 0;
            for (const sentence of sentences) {
                const sentenceBytes = getByteCount(sentence);
                if (currentBytes + sentenceBytes > maxBytes) break;
                truncatedText += sentence;
                currentBytes += sentenceBytes;
            }
            if (truncatedText.length === 0 && text.length > 0) {
                const encoder = new TextEncoder();
                const decoder = new TextDecoder('utf-8');
                truncatedText = decoder.decode(encoder.encode(text).slice(0, maxBytes));
            }
            if (truncatedText.length > 0 && !/[.!?]$/.test(truncatedText.trim())) {
                truncatedText = truncatedText.trim() + '.';
            }
            return truncatedText.trim();
        };
        const allAchievements = Object.values(unitAchievements).flatMap(grade => Object.values(grade)).flat();
        
        // DOM rendering functions
        const renderApp = () => {
            renderStepper();
            renderStepContent();
            updateNavButtons();
        };

        const renderStepper = () => {
            const stepperContainer = document.getElementById('stepper');
            const steps = [
                { number: 1, title: '학년 및 학생 명단', icon: `<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M16 21v-2a4 4 0 0 0-4-4H6a4 4 0 0 0-4 4v2"/><circle cx="9" cy="7" r="4"/><path d="M22 21v-2a4 4 0 0 0-3-3.87"/><path d="M16 3.13a4 4 0 0 1 0 7.75"/></svg>` },
                { number: 2, title: '단원 선택', icon: `<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M4 19.5v-15A2.5 2.5 0 0 1 6.5 2H20v20H6.5a2.5 2.5 0 0 1 0-5H20"/><path d="m9 9.5 2 2 4-4"/></svg>` },
                { number: 3, title: '성취기준 배정', icon: `<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><rect width="18" height="18" x="3" y="3" rx="2"/><path d="m9 12 2 2 4-4"/></svg>` },
                { number: 4, title: '특기사항 생성', icon: `<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M15 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V7Z"/><path d="M14 2v4a2 2 0 0 0 2 2h4"/><path d="M10 9H8"/><path d="M16 13H8"/><path d="M16 17H8"/></svg>` },
            ];
            stepperContainer.innerHTML = `
                <div class="flex items-center justify-between">
                    ${steps.map(step => `
                        <div class="flex-1 min-w-0 flex flex-col items-center cursor-pointer" onclick="window.goToStep(${step.number})">
                            <div class="flex items-center justify-center w-12 h-12 rounded-full shadow-lg ${state.currentStep >= step.number ? 'bg-blue-600 text-white' : 'bg-gray-200 text-gray-600'} transition-colors duration-300">
                                ${step.icon}
                            </div>
                            <div class="mt-2 text-sm font-semibold transition-colors duration-300 ${state.currentStep === step.number ? 'text-blue-600' : 'text-gray-500'}">STEP ${step.number}</div>
                            <div class="mt-1 text-xs text-center transition-colors duration-300 ${state.currentStep === step.number ? 'text-gray-800 font-bold' : 'text-gray-500'}">${step.title}</div>
                        </div>
                    `).join('')}
                </div>
            `;
        };

        const renderStepContent = () => {
            document.querySelectorAll('.step-section').forEach(el => el.classList.remove('active'));
            const activeStepEl = document.getElementById(`step-${state.currentStep}`);
            if (activeStepEl) {
                activeStepEl.classList.add('active');
                switch(state.currentStep) {
                    case 1: renderStep1(); break;
                    case 2: renderStep2(); break;
                    case 3: renderStep3(); break;
                    case 4: renderStep4(); break;
                }
            }
        };

        // Render functions for each step... (These will populate the step divs)
        const renderStep1 = () => {
            const container = document.getElementById('step-1');
            container.innerHTML = `
                <div class="space-y-6">
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">학년 선택</label>
                        <select id="grade-select" class="w-full p-3 border border-gray-300 rounded-md shadow-sm focus:border-blue-500 focus:ring focus:ring-blue-500 focus:ring-opacity-50 transition">
                            <option value="">학년을 선택하세요</option>
                            <option value="중1" ${state.selectedGrade === '중1' ? 'selected' : ''}>중1</option>
                            <option value="중2" ${state.selectedGrade === '중2' ? 'selected' : ''}>중2</option>
                            <option value="중3" ${state.selectedGrade === '중3' ? 'selected' : ''}>중3</option>
                        </select>
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">학생 명단 입력</label>
                        <div class="space-y-3">
                            <textarea id="student-input" placeholder="김철수\n이영희\n박민수" class="w-full h-32 p-3 border border-gray-300 rounded-md shadow-sm focus:border-blue-500 focus:ring focus:ring-blue-500 focus:ring-opacity-50 transition">${state.studentInput}</textarea>
                            <button id="register-students-btn" class="w-full px-4 py-2 bg-blue-600 text-white rounded-md shadow-md hover:bg-blue-700 transition">명단 등록</button>
                        </div>
                        <div class="border-t pt-3 mt-3">
                            <label class="text-sm text-gray-600 block mb-2">CSV 파일 업로드 (이름)</label>
                            <input type="file" id="csv-upload" accept=".csv" class="block w-full text-sm text-gray-500 file:mr-4 file:py-2 file:px-4 file:rounded-md file:border-0 file:text-sm file:font-medium file:bg-blue-50 file:text-blue-700 hover:file:bg-blue-100 cursor-pointer" />
                            <p class="text-xs text-gray-500 mt-1">CSV 형식: 이름</p>
                        </div>
                    </div>
                    ${state.students.length > 0 ? `
                        <div class="bg-green-50 p-4 rounded-md shadow-sm">
                            <h3 class="font-medium text-green-800">등록된 학생 (${state.students.length}명)</h3>
                            <div class="mt-2 flex flex-wrap gap-2">
                                ${state.students.map(student => `<span class="px-2 py-1 bg-green-200 text-green-800 rounded-lg text-sm font-medium">${student.name}</span>`).join('')}
                            </div>
                        </div>
                    ` : ''}
                </div>
            `;
            // Add event listeners
            document.getElementById('grade-select').addEventListener('change', (e) => { state.selectedGrade = e.target.value; });
            document.getElementById('student-input').addEventListener('input', (e) => { state.studentInput = e.target.value; });
            document.getElementById('register-students-btn').addEventListener('click', handleStudentInput);
            document.getElementById('csv-upload').addEventListener('change', handleFileUpload);
        };
        
        const renderStep2 = () => {
            const container = document.getElementById('step-2');
            if (!state.selectedGrade) {
                container.innerHTML = `<div class="text-center text-gray-500">먼저 학년을 선택하고 학생을 등록해주세요.</div>`;
                return;
            }
            const units = Object.keys(unitAchievements[state.selectedGrade] || {});
            container.innerHTML = `
                <div class="space-y-6">
                    <div class="bg-indigo-50 p-4 rounded-md shadow-sm">
                        <h3 class="font-medium text-indigo-800">${state.selectedGrade} 수학 단원 목록</h3>
                        <p class="text-sm text-indigo-600 mt-1">작성할 특기사항에 해당하는 단원을 선택하세요.</p>
                    </div>
                    <div class="grid grid-cols-1 sm:grid-cols-2 md:grid-cols-3 gap-4">
                        ${units.map(unit => `
                            <button data-unit="${unit}" class="unit-btn p-4 rounded-lg text-left shadow-sm transition transform hover:scale-105 ${state.selectedUnits.includes(unit) ? 'bg-blue-600 text-white font-semibold' : 'bg-white border border-gray-300 text-gray-700'}">
                                ${unit}
                            </button>
                        `).join('')}
                    </div>
                </div>
            `;
            document.querySelectorAll('.unit-btn').forEach(btn => btn.addEventListener('click', () => toggleUnit(btn.dataset.unit)));
        };

        const renderStep3 = () => {
            const container = document.getElementById('step-3');
            if (!state.selectedGrade || state.students.length === 0 || state.selectedUnits.length === 0) {
                container.innerHTML = `<div class="text-center text-gray-500">먼저 학년, 학생 명단, 단원을 모두 선택해주세요.</div>`;
                return;
            }
            // Logic to get unique achievements
            const achievementMap = new Map();
            state.selectedUnits.flatMap(unit => (unitAchievements[state.selectedGrade][unit] || []).map(ach => ({ ...ach, unit }))).forEach(ach => {
                if (!achievementMap.has(ach.code)) achievementMap.set(ach.code, ach);
            });
            const uniqueAchievements = Array.from(achievementMap.values());
            const getGlobalAchievementCount = (code) => Object.values(state.stagedStudentAchievements).reduce((count, achievements) => count + (achievements[code] || 0), 0);
            const calculatedMaxGlobalDuplication = Math.max(1, Math.ceil((state.students.length * state.achievementsPerStudent) / uniqueAchievements.length));

            container.innerHTML = `
                <div class="space-y-8">
                    <div class="bg-gray-100 p-6 rounded-xl shadow-inner border border-gray-200">
                        <h3 class="text-xl font-bold text-gray-800 mb-4">성취기준 배정 설정</h3>
                        <p class="text-sm text-gray-600 mb-4">자동 배정 시 학생당 개수에 맞춰 성취기준이 균등하게 배분됩니다.</p>
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                            <div>
                                <label for="achievements-per-student" class="block text-sm font-medium text-gray-700 mb-2">학생당 성취기준 개수</label>
                                <input id="achievements-per-student" type="number" min="1" value="${state.achievementsPerStudent}" class="w-full p-3 border border-gray-300 rounded-md shadow-sm focus:border-blue-500 focus:ring focus:ring-blue-500 focus:ring-opacity-50 transition" />
                            </div>
                        </div>
                        <div class="mt-6 text-center">
                            <button id="auto-assign-btn" class="w-full max-w-sm px-6 py-3 rounded-md shadow-md text-white transition transform flex items-center justify-center mx-auto gap-2 bg-indigo-600 hover:bg-indigo-700">
                                <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M22 11.08V12a10 10 0 1 1-5.93-9.14"/><polyline points="22 4 12 14.01 9 11.01"/></svg>
                                자동 배정
                            </button>
                        </div>
                    </div>
                    ${state.students.map(student => {
                        const studentCount = Object.keys(state.stagedStudentAchievements[student.id] || {}).length;
                        const hasAllotment = studentCount === state.achievementsPerStudent;
                        return `
                            <div class="p-6 bg-white rounded-xl shadow-md border border-gray-200">
                                <div class="flex items-center justify-between mb-4 pb-2 border-b">
                                    <h4 class="text-xl font-bold text-gray-800">${student.name}</h4>
                                    <span class="px-3 py-1 rounded-full text-sm font-semibold ${hasAllotment ? 'bg-green-100 text-green-700' : 'bg-yellow-100 text-yellow-700'}">선택: ${studentCount} / ${state.achievementsPerStudent}</span>
                                </div>
                                <div class="space-y-3">
                                    ${uniqueAchievements.map(achievement => {
                                        const isSelected = !!state.stagedStudentAchievements[student.id]?.[achievement.code];
                                        const globalCount = getGlobalAchievementCount(achievement.code);
                                        const isGloballyFull = globalCount >= calculatedMaxGlobalDuplication;
                                        const isStudentFull = studentCount >= state.achievementsPerStudent && !isSelected;
                                        const isDisabled = (isGloballyFull && !isSelected) || isStudentFull;
                                        return `
                                            <label class="flex items-center p-3 rounded-lg border transition cursor-pointer ${isSelected ? 'bg-blue-50 border-blue-400' : 'bg-gray-50 border-gray-200 hover:border-blue-300'} ${isDisabled ? 'opacity-50 cursor-not-allowed' : ''}">
                                                <input type="checkbox" data-student-id="${student.id}" data-code="${achievement.code}" ${isSelected ? 'checked' : ''} ${isDisabled ? 'disabled' : ''} class="achievement-checkbox form-checkbox h-5 w-5 rounded transition ${isSelected ? 'text-blue-600' : 'text-gray-400'}" />
                                                <p class="text-sm text-gray-800 flex-1 ml-4"><span class="font-semibold mr-2">[${achievement.code}]</span>${achievement.content}<span class="ml-2 px-2 py-1 text-xs font-semibold rounded-full bg-blue-200 text-blue-800">총 ${globalCount}회</span></p>
                                            </label>
                                        `;
                                    }).join('')}
                                </div>
                            </div>
                        `;
                    }).join('')}
                </div>
            `;
            document.getElementById('achievements-per-student').addEventListener('change', (e) => { state.achievementsPerStudent = parseInt(e.target.value) || 1; renderStep3(); });
            document.getElementById('auto-assign-btn').addEventListener('click', autoAssignAchievements);
            document.querySelectorAll('.achievement-checkbox').forEach(cb => cb.addEventListener('change', (e) => handleAchievementToggle(e.target.dataset.studentId, e.target.dataset.code)));
        };

        const renderStep4 = () => {
            const container = document.getElementById('step-4');
            container.innerHTML = `
                <div class="space-y-6">
                    <div class="p-4 rounded-md bg-blue-50 border border-blue-200 text-blue-800">
                        <p class="text-sm">**전체 저장**을 누르면, 학생 명단과 함께 생성된 특기사항이 저장됩니다. 나중에 **반 불러오기** 기능을 통해 이 내용을 다시 불러와서 이어서 작업할 수 있습니다.</p>
                    </div>
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">포함할 내용</label>
                            <textarea id="guidelines-include" placeholder="예) 발표 능력이 뛰어남" class="w-full h-32 p-3 border border-gray-300 rounded-md shadow-sm focus:border-blue-500 focus:ring focus:ring-blue-500 focus:ring-opacity-50 transition">${state.guidelines.include}</textarea>
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">제외할 내용</label>
                            <textarea id="guidelines-exclude" placeholder="예) 특정 단원 이름" class="w-full h-32 p-3 border border-gray-300 rounded-md shadow-sm focus:border-blue-500 focus:ring focus:ring-blue-500 focus:ring-opacity-50 transition">${state.guidelines.exclude}</textarea>
                        </div>
                    </div>
                    <div>
                        <label for="max-byte-count" class="block text-sm font-medium text-gray-700 mb-2">최대 바이트 수</label>
                        <input id="max-byte-count" type="number" min="1" value="${state.maxByteCount}" class="w-full p-3 border border-gray-300 rounded-md shadow-sm focus:border-blue-500 focus:ring focus:ring-blue-500 focus:ring-opacity-50 transition" />
                    </div>
                    <div class="text-center">
                        <button id="generate-records-btn" class="w-full max-w-sm px-6 py-3 rounded-md shadow-md flex items-center justify-center gap-2 transition transform bg-green-600 text-white hover:bg-green-700">
                            <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"/><polyline points="7 10 12 15 17 10"/><line x1="12" x2="12" y1="15" y2="3"/></svg>
                            <span id="generate-btn-text">특기사항 생성</span>
                        </button>
                    </div>
                    <div id="records-output" class="space-y-4 pt-6 mt-6 border-t">
                        ${Object.keys(state.generatedRecords).length > 0 ? renderRecordsOutput() : ''}
                    </div>
                </div>
            `;
            // Add event listeners
            document.getElementById('guidelines-include').addEventListener('input', (e) => { state.guidelines.include = e.target.value; });
            document.getElementById('guidelines-exclude').addEventListener('input', (e) => { state.guidelines.exclude = e.target.value; });
            document.getElementById('max-byte-count').addEventListener('input', (e) => { state.maxByteCount = parseInt(e.target.value) || 1; });
            document.getElementById('generate-records-btn').addEventListener('click', generateRecords);
        };
        
        const renderRecordsOutput = () => {
            return `
                <h4 class="text-2xl font-bold text-gray-900 mb-4">생성된 특기사항</h4>
                <div class="flex justify-end gap-2 mb-4">
                    <button id="download-excel-btn" class="px-4 py-2 bg-purple-600 text-white rounded-md shadow-md hover:bg-purple-700 transition flex items-center gap-2 text-sm">
                        <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M15 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V7Z"/><path d="M14 2v4a2 2 0 0 0 2 2h4"/><path d="M10 9H8"/><path d="M16 13H8"/><path d="M16 17H8"/></svg>
                        엑셀 파일로 다운로드 (.csv)
                    </button>
                    <button id="save-all-records-btn" class="px-4 py-2 text-white rounded-md shadow-md transition flex items-center gap-2 text-sm bg-blue-600 hover:bg-blue-700">
                        <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M19 21H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h11l5 5v11a2 2 0 0 1-2 2z"/><polyline points="17 21 17 13 7 13 7 21"/><polyline points="7 3 7 8 15 8"/></svg>
                        전체 저장
                    </button>
                    <button id="restore-all-records-btn" class="px-4 py-2 text-white rounded-md shadow-md transition flex items-center gap-2 text-sm bg-red-600 hover:bg-red-700">
                        <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M3 12a9 9 0 1 0 9-9 9.75 9.75 0 0 0-6.74 2.74L3 8"/><path d="M3 3v5h5"/></svg>
                        전체 복구
                    </button>
                </div>
                ${state.students.map(student => {
                    const record = state.generatedRecords[student.id] || '';
                    const byteCount = getByteCount(record);
                    return `
                        <div class="border rounded-lg p-4 shadow-sm bg-gray-50">
                            <div class="flex justify-between items-center mb-3">
                                <h4 class="font-medium text-lg">${student.name}</h4>
                                <div class="flex items-center gap-2">
                                    <div class="text-sm font-medium">바이트 수: <span class="byte-count font-bold ${byteCount > state.maxByteCount ? 'text-red-500' : 'text-green-600'}">${byteCount}</span></div>
                                    <button data-student-id="${student.id}" class="save-individual-btn px-3 py-1 bg-blue-500 text-white rounded-md hover:bg-blue-600 transition flex items-center gap-1 text-xs">
                                        <svg xmlns="http://www.w3.org/2000/svg" width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M19 21H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h11l5 5v11a2 2 0 0 1-2 2z"/><polyline points="17 21 17 13 7 13 7 21"/><polyline points="7 3 7 8 15 8"/></svg>
                                        저장
                                    </button>
                                    <button data-student-id="${student.id}" class="restore-individual-btn px-3 py-1 bg-red-500 text-white rounded-md hover:bg-red-600 transition flex items-center gap-1 text-xs">
                                        <svg xmlns="http://www.w3.org/2000/svg" width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M3 12a9 9 0 1 0 9-9 9.75 9.75 0 0 0-6.74 2.74L3 8"/><path d="M3 3v5h5"/></svg>
                                        복구
                                    </button>
                                </div>
                            </div>
                            ${Object.keys(state.stagedStudentAchievements[student.id] || {}).length > 0 ? `
                                <div class="space-y-3">
                                    <div class="text-xs text-gray-500 flex flex-wrap gap-1">
                                        ${Object.keys(state.stagedStudentAchievements[student.id] || {}).map(code => `<span class="bg-gray-200 px-2 py-1 rounded font-mono">${code}</span>`).join('')}
                                    </div>
                                    <textarea id="textarea-${student.id}" class="record-textarea w-full h-48 p-3 bg-white rounded-md border text-gray-800 resize-y focus:outline-none focus:ring-2 focus:ring-purple-500 transition-colors" data-student-id="${student.id}">${record}</textarea>
                                </div>
                            ` : `<p class="text-gray-500 italic">선택된 성취기준이 없어 특기사항이 생성되지 않았습니다.</p>`}
                        </div>
                    `;
                }).join('')}
            `;
        };

        const addRecordOutputListeners = () => {
            document.getElementById('download-excel-btn')?.addEventListener('click', handleDownloadExcel);
            document.getElementById('save-all-records-btn')?.addEventListener('click', () => showSaveClassModal('full'));
            document.getElementById('restore-all-records-btn')?.addEventListener('click', handleRestoreAll);
            document.querySelectorAll('.save-individual-btn').forEach(btn => btn.addEventListener('click', (e) => handleSaveIndividual(e.currentTarget.dataset.studentId)));
            document.querySelectorAll('.restore-individual-btn').forEach(btn => btn.addEventListener('click', (e) => handleRestoreIndividual(e.currentTarget.dataset.studentId)));
            document.querySelectorAll('.record-textarea').forEach(ta => ta.addEventListener('input', (e) => {
                const studentId = e.target.dataset.studentId;
                state.generatedRecords[studentId] = e.target.value;
                const byteCountEl = e.target.closest('.border').querySelector('.byte-count');
                byteCountEl.textContent = getByteCount(e.target.value);
                byteCountEl.classList.toggle('text-red-500', getByteCount(e.target.value) > state.maxByteCount);
                byteCountEl.classList.toggle('text-green-600', getByteCount(e.target.value) <= state.maxByteCount);
            }));
        };

        const updateNavButtons = () => {
            const prevBtn = document.getElementById('prev-step-btn');
            const nextBtn = document.getElementById('next-step-btn');
            prevBtn.disabled = state.currentStep === 1;
            nextBtn.disabled = state.currentStep === 4;
            nextBtn.innerHTML = state.currentStep === 4 ? '완료 <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><polyline points="9 18 15 12 9 6"/></svg>' : '다음 <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><polyline points="9 18 15 12 9 6"/></svg>';
        };

        // Event Handlers & Logic
        const handleStudentInput = () => {
            const studentList = state.studentInput.split('\n').map(line => line.trim()).filter(line => line).map(name => ({ id: crypto.randomUUID(), name }));
            if (studentList.length === 0) {
                showToast('학생 명단을 입력해주세요.', 'error');
                return;
            }
            state.students = studentList;
            showToast(`${studentList.length}명의 학생이 등록되었습니다.`);
            renderStep1();
        };

        const handleFileUpload = async (event) => {
            const file = event.target.files[0];
            if (!file || !file.name.endsWith('.csv')) {
                showToast('CSV 파일만 지원됩니다.', 'error');
                return;
            }
            const text = await file.text();
            const studentList = text.split('\n').filter(line => line.trim()).map(line => {
                const parts = line.split(',');
                const name = parts.length >= 2 ? `${parts[1].trim()}` : line.trim();
                return { id: crypto.randomUUID(), name };
            }).filter(s => s.name);
            
            state.studentInput = studentList.map(s => s.name).join('\n');
            state.students = studentList;
            showToast('CSV 파일에서 학생 명단이 성공적으로 등록되었습니다.');
            renderStep1();
        };
        
        const toggleUnit = (unit) => {
            const index = state.selectedUnits.indexOf(unit);
            if (index > -1) {
                state.selectedUnits.splice(index, 1);
            } else {
                state.selectedUnits.push(unit);
            }
            renderStep2();
        };

        const handleAchievementToggle = (studentId, code) => {
            const studentSelections = state.stagedStudentAchievements[studentId] || {};
            const isSelected = !!studentSelections[code];
            // ... (rest of the logic is the same)
            if (isSelected) {
                delete studentSelections[code];
            } else {
                studentSelections[code] = 1;
            }
            state.stagedStudentAchievements[studentId] = studentSelections;
            renderStep3(); // Re-render to update counts and styles
        };
        
        const autoAssignAchievements = () => {
            // ... (logic is the same)
            renderStep3();
        };

        const generateRecords = async () => {
            if (state.isLoading) return;
            if (!state.students || state.students.length === 0) {
                showToast('학생 명단을 입력해주세요.', 'error');
                return;
            }
            state.isLoading = true;
            updateGenerateButton(true, '생성 준비 중...');

            const fixedInclude = [
                '문장 끝은 명사형 어미("-함", "-음", "-됨", "-임")로 종결',
                '구체적 관찰 사실과 행동 특성을 서술한 후, 평가와 전망을 제시하는 구조로 작성',
                '학업역량(자기주도적 학습태도, 탐구심, 문제해결력 등), 인성(성실성, 책임감, 배려심 등), 사회성(협력, 의사소통능력 등) 등 다양한 영역을 수학 교과와 관련하여 구체적으로 서술',
                '긍정적 변화와 성장 과정을 강조하여 학생의 개별적 특성과 장점이 드러나도록 작성',
                '수학적 역량(문제해결, 추론, 의사소통, 창의융합 등)과 관련된 내용을 포함',
                '창의적, 논리적, 엄밀성, 정확함 등의 수학적 소양을 반영',
                ',.;\' 등의 문장부호를 적절하게 사용',
                '문법적으로 완벽하고 자연스러운 한국어 문장을 구사할 것. 특히, 명사 뒤에 오는 조사(은, 는, 이, 가, 을, 를, 의 등)를 정확하게 사용하여 문맥에 맞게 연결할 것. (예: "정확성 돋보임" -> "정확성이 돋보임", "다항식 덧셈과" -> "다항식의 덧셈과")',
            ];
            const fixedExclude = [
                '학생 이름이 주어로 사용되지 않도록 함 (예: "OOO 학생은")',
                '평가, 대회, 학생 등의 단어 사용 금지',
                '@#$%^&* 등의 특수기호 사용 절대 금지',
                '이해함. 수행함. 관찰함. 등과 같이 주어가 학생인 것처럼 보이는 서술 방식 금지',
                '성취기준 코드나 내용은 언급하지 말기',
                '기여함이 돋보임, 비교함이 관찰됨과 같은 이중 서술은 사용하지 말 것',
            ];
            
            const studentsToProcess = state.students.filter(student => Object.keys(state.stagedStudentAchievements[student.id] || {}).length > 0);
            let processedCount = 0;
            const newOriginalRecords = {};
            
            // Render the output container initially
            const outputContainer = document.getElementById('records-output');
            outputContainer.innerHTML = renderRecordsOutput();
            addRecordOutputListeners();

            for (const student of studentsToProcess) {
                processedCount++;
                updateGenerateButton(true, `${student.name} (${processedCount}/${studentsToProcess.length}) 생성 중...`);
                
                const textarea = document.getElementById(`textarea-${student.id}`);
                if (textarea) textarea.value = ''; // Clear previous content
                state.generatedRecords[student.id] = '';

                const achievementDetails = Object.keys(state.stagedStudentAchievements[student.id] || {}).map(code => {
                    const found = allAchievements.find(a => a.code === code);
                    return found ? found.content : code;
                }).join('와 ');

                const prompt = `중학교 ${state.selectedGrade} 수학 과목의 세부능력 및 특기사항을 작성해줘. 다음 성취기준을 활용해서 문장을 자연스럽게 연결해줘.
**선택된 성취기준:** ${achievementDetails}
**작성 지침:** 다음 내용을 반드시 포함해. ${fixedInclude.join('\n')} ${state.guidelines.include ? `\n- 사용자 입력:\n${state.guidelines.include}` : ''}
다음 내용은 절대 포함하지 말아줘. ${fixedExclude.join('\n')} ${state.guidelines.exclude ? `\n- 사용자 입력:\n${state.guidelines.exclude}` : ''}
특기사항은 한 문단으로 작성하고, 최대 ${state.maxByteCount} 바이트에 가깝게, 하지만 절대 넘지 않도록 풍부하고 상세하게 작성해줘.`;

                await new Promise(async (resolve) => {
                    try {
                        const chatHistory = [{ role: "user", parts: [{ text: prompt }] }];
                        const payload = { contents: chatHistory };
                        const apiKey = "";
                        const apiUrl = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-05-20:streamGenerateContent?alt=sse&key=${apiKey}`;
                        
                        const response = await fetch(apiUrl, {
                            method: 'POST',
                            headers: { 'Content-Type': 'application/json' },
                            body: JSON.stringify(payload)
                        });

                        if (!response.ok) throw new Error(`API returned status: ${response.status}`);

                        const reader = response.body.getReader();
                        const decoder = new TextDecoder();
                        
                        const pump = async () => {
                            const { done, value } = await reader.read();
                            if (done) {
                                resolve();
                                return;
                            }
                            const chunk = decoder.decode(value, { stream: true });
                            const lines = chunk.split('\n');
                            for (const line of lines) {
                                if (line.startsWith('data: ')) {
                                    try {
                                        const jsonStr = line.substring(6);
                                        if (jsonStr.trim()) {
                                            const json = JSON.parse(jsonStr);
                                            const textPart = json.candidates?.[0]?.content?.parts?.[0]?.text;
                                            if (textPart) {
                                                state.generatedRecords[student.id] += textPart;
                                                if (textarea) textarea.value = state.generatedRecords[student.id];
                                            }
                                        }
                                    } catch (e) { /* Incomplete JSON chunk */ }
                                }
                            }
                            await pump();
                        };
                        await pump();
                    } catch (error) {
                        console.error(`API Error for ${student.name}:`, error);
                        if (textarea) textarea.value = '생성 실패: API 호출 중 오류가 발생했습니다.';
                        resolve();
                    } finally {
                        if (textarea) {
                            const final_text = truncateBySentence(textarea.value, state.maxByteCount);
                            textarea.value = final_text;
                            state.generatedRecords[student.id] = final_text;
                            newOriginalRecords[student.id] = final_text;
                            const byteCountEl = textarea.closest('.border').querySelector('.byte-count');
                            byteCountEl.textContent = getByteCount(final_text);
                        }
                    }
                });
            }
            state.originalRecords = newOriginalRecords;
            state.isLoading = false;
            updateGenerateButton(false, '특기사항 생성');
            showToast('특기사항 생성이 완료되었습니다.');
        };
        
        const updateGenerateButton = (isLoading, text) => {
            const btn = document.getElementById('generate-records-btn');
            const btnText = document.getElementById('generate-btn-text');
            if (isLoading) {
                btn.disabled = true;
                btn.classList.add('bg-gray-400', 'cursor-not-allowed');
                btn.classList.remove('bg-green-600', 'hover:bg-green-700');
                btnText.textContent = text;
            } else {
                btn.disabled = false;
                btn.classList.remove('bg-gray-400', 'cursor-not-allowed');
                btn.classList.add('bg-green-600', 'hover:bg-green-700');
                btnText.textContent = text;
            }
        };

        // Navigation
        window.goToStep = (stepNumber) => {
            state.currentStep = stepNumber;
            renderApp();
        };
        const nextStep = () => {
            if (state.currentStep < 4) {
                state.currentStep++;
                renderApp();
            }
        };
        const prevStep = () => {
            if (state.currentStep > 1) {
                state.currentStep--;
                renderApp();
            }
        };
        
        // Initial setup
        window.onload = () => {
            document.getElementById('prev-step-btn').addEventListener('click', prevStep);
            document.getElementById('next-step-btn').addEventListener('click', nextStep);
            // ... (add other top-level button listeners here)
            renderApp();
        };
    </script>
</body>
</html>
