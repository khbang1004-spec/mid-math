<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>중학교 수학 세부능력 특기사항 작성기 (ver.2)</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Noto+Sans+KR:wght@400;500;700;900&display=swap');
        body { font-family: 'Noto Sans KR', sans-serif; }
        .hidden { display: none; }
        .step-section { display: none; }
        .step-section.active { display: block; }
        @keyframes slideIn {
          from { transform: translateY(20px); opacity: 0; }
          to { transform: translateY(0); opacity: 1; }
        }
        .animate-slideIn { animation: slideIn 0.5s ease-out forwards; }
        .loader {
            border: 4px solid #f3f3f3;
            border-top: 4px solid #3498db;
            border-radius: 50%;
            width: 20px;
            height: 20px;
            animation: spin 1s linear infinite;
        }
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        .modal-overlay {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background-color: rgba(0, 0, 0, 0.6);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 100;
            animation: fadeIn 0.3s ease-out;
        }
        @keyframes fadeIn {
            from { opacity: 0; }
            to { opacity: 1; }
        }
    </style>
</head>
<body class="bg-gray-50">

    <div id="app-wrapper" class="max-w-6xl mx-auto p-6 min-h-screen">

        <!-- 로그인 화면 -->
        <div id="login-container" class="flex flex-col items-center justify-center min-h-[80vh]">
            <div class="text-center p-8 bg-white rounded-2xl shadow-xl border border-gray-200">
                <h1 class="text-5xl font-extrabold text-gray-800 mb-4">중학교 수학 세특 작성기</h1>
                <p class="text-2xl text-gray-600 mb-12">(ver.2)</p>
                <button id="login-btn" class="bg-white hover:bg-gray-100 text-gray-800 font-semibold py-3 px-8 border border-gray-300 rounded-lg shadow-md transition transform hover:scale-105 flex items-center gap-3 mx-auto">
                    <svg class="w-6 h-6" viewBox="0 0 48 48"><path fill="#4285F4" d="M43.611 20.083H42V20H24v8h11.303c-1.649 4.657-6.08 8-11.303 8c-6.627 0-12-5.373-12-12s5.373-12 12-12c3.059 0 5.842 1.154 7.961 3.039l5.657-5.657C34.046 6.053 29.268 4 24 4C12.955 4 4 12.955 4 24s8.955 20 20 20s20-8.955 20-20c0-1.341-.138-2.65-.389-3.917z"></path><path fill="#34A853" d="M43.611 20.083H42V20H24v8h11.303c-1.649 4.657-6.08 8-11.303 8V44c5.268 0 10.046-1.947 13.611-5.657c3.565-3.71 5.657-8.857 5.657-14.343c0-1.341-.138-2.65-.389-3.917z"></path><path fill="#FBBC05" d="M9.961 16.304A11.945 11.945 0 0 0 8 24c0 1.575.293 3.083.824 4.47l-5.657 5.657A19.93 19.93 0 0 1 0 24c0-4.93 1.805-9.42 4.78-12.923l5.181 9.227z"></path><path fill="#EA4335" d="M24 8c-3.059 0-5.842 1.154-7.961 3.039l-5.657-5.657C13.954 1.947 18.732 0 24 0c5.268 0 10.046 1.947 13.611 5.657L32 11.314A11.962 11.962 0 0 0 24 8z"></path></svg>
                    Google 계정으로 로그인
                </button>
            </div>
        </div>

        <!-- 메인 앱 컨텐츠 -->
        <div id="app-container" class="hidden">
            <div id="toast-container" class="fixed top-4 right-4 z-50 space-y-2"></div>
            <div id="modal-container"></div>
            
            <header class="flex justify-between items-start mb-8">
                <div>
                    <h1 class="text-4xl font-extrabold text-gray-900 mb-2">중학교 수학 세부능력 특기사항 작성기</h1>
                    <p class="text-lg text-gray-600">(ver.2)</p>
                </div>
                <div id="user-profile" class="flex items-center gap-4">
                    <!-- 사용자 정보 및 로그아웃 버튼이 여기에 표시됩니다. -->
                </div>
            </header>
            
            <main class="main-content">
                <div id="stepper" class="mb-10">
                    <!-- Stepper will be injected here by JavaScript -->
                </div>

                <div class="bg-white p-8 rounded-2xl shadow-xl border border-gray-200">
                    <div id="step-1" class="step-section active"></div>
                    <div id="step-2" class="step-section"></div>
                    <div id="step-3" class="step-section"></div>
                    <div id="step-4" class="step-section"></div>
                </div>

                <div class="flex justify-between mt-8">
                    <button id="prev-step-btn" class="flex items-center gap-2 px-6 py-3 rounded-md text-gray-600 border border-gray-300 shadow-sm hover:bg-gray-100 disabled:opacity-50 disabled:cursor-not-allowed transition">
                        <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><polyline points="15 18 9 12 15 6"/></svg>
                        이전
                    </button>
                    <button id="next-step-btn" class="flex items-center gap-2 px-6 py-3 rounded-md bg-blue-600 text-white shadow-sm hover:bg-blue-700 disabled:opacity-50 disabled:cursor-not-allowed transition">
                        다음
                        <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><polyline points="9 18 15 12 9 6"/></svg>
                    </button>
                </div>
            </main>
        </div>
    </div>

    <script type="module">
        // Firebase SDK Imports
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, GoogleAuthProvider, signInWithPopup, signOut, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        
        // --- Firebase Configuration ---
        const firebaseConfig = {
            apiKey: "AIzaSyBzav3lUsC6YGdrKdGcH-EVsydj1LPPfws",
            authDomain: "mid-math.firebaseapp.com",
            projectId: "mid-math",
            storageBucket: "mid-math.appspot.com",
            messagingSenderId: "485668916042",
            appId: "1:485668916042:web:d7c989e020671bc36c4fb3",
            measurementId: "G-V3YJR7X29Z"
        };

        // Initialize Firebase
        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const provider = new GoogleAuthProvider();

        // --- DOM Elements ---
        const loginContainer = document.getElementById('login-container');
        const appContainer = document.getElementById('app-container');
        const loginBtn = document.getElementById('login-btn');
        const userProfileContainer = document.getElementById('user-profile');

        // --- Authentication Logic ---
        const signInWithGoogle = async () => {
            try {
                await signInWithPopup(auth, provider);
            } catch (error) {
                console.error("Google 로그인 중 오류 발생:", error);
                showToast('로그인 중 오류가 발생했습니다.', 'error');
            }
        };

        const signOutUser = async () => {
            try {
                await signOut(auth);
            } catch (error) {
                console.error("로그아웃 중 오류 발생:", error);
                showToast('로그아웃 중 오류가 발생했습니다.', 'error');
            }
        };

        // --- UI Control based on Auth State ---
        onAuthStateChanged(auth, (user) => {
            if (user) {
                loginContainer.classList.add('hidden');
                appContainer.classList.remove('hidden');
                appContainer.classList.add('animate-slideIn');

                userProfileContainer.innerHTML = `
                    <span class="font-semibold text-gray-700">${user.displayName}님</span>
                    <img src="${user.photoURL}" alt="프로필 사진" class="w-10 h-10 rounded-full border-2 border-gray-300">
                    <button id="logout-btn" class="px-4 py-2 bg-red-500 text-white text-sm rounded-md shadow-sm hover:bg-red-600 transition">로그아웃</button>
                `;
                document.getElementById('logout-btn').addEventListener('click', signOutUser);
                
                initializeAppLogic();

            } else {
                appContainer.classList.add('hidden');
                loginContainer.classList.remove('hidden');
                userProfileContainer.innerHTML = '';
            }
        });
        
        // --- Main App Logic ---
        
        let state = {
            currentStep: 1,
            students: [],
            studentInput: '',
            selectedGrade: '',
            selectedUnits: [],
            stagedStudentAchievements: {},
            generatedRecords: {},
            originalRecords: {},
            isLoading: false,
            guidelines: { include: '', exclude: '' },
            maxByteCount: 1000,
            achievementsPerStudent: 3,
        };
        
        const unitAchievements = {
          '중1': {
            '소인수분해': [{ code: '9수01-01', content: '소인수분해를 이용하여 최대공약수와 최소공배수를 구할 수 있다.' }, { code: '9수01-02', content: '정수와 유리수의 개념을 이해하고, 수의 대소 관계를 비교할 수 있다.' }],
            '정수와 유리수': [{ code: '9수01-03', content: '정수와 유리수의 덧셈과 뺄셈의 원리를 이해하고 계산할 수 있다.' }, { code: '9수01-04', content: '정수와 유리수의 곱셈과 나눗셈의 원리를 이해하고 계산할 수 있다.' }, { code: '9수01-05', content: '정수와 유리수의 사칙연산이 혼합된 계산의 순서를 알고 계산할 수 있다.' }],
            '문자의 사용과 식': [{ code: '9수02-01', content: '문자를 사용하여 식을 간단히 나타낼 수 있다.' }, { code: '9수02-02', content: '단항식의 곱셈과 나눗셈의 원리를 이해하고 계산할 수 있다.' }],
            '일차방정식': [{ code: '9수02-03', content: '일차방정식의 개념과 풀이 방법을 이해하고 문제를 해결할 수 있다.' }, { code: '9수02-04', content: '일차방정식을 활용하여 다양한 실생활 문제를 해결할 수 있다.' }],
            '좌표평면과 그래프': [{ code: '9수02-05', content: '좌표평면 위의 점의 좌표를 이해하고, 이를 이용하여 문제를 해결할 수 있다.' }, { code: '9수02-06', content: '정비례 관계의 의미를 알고, 그 그래프를 그릴 수 있다.' }, { code: '9수02-07', content: '반비례 관계의 의미를 알고, 그 그래프를 그릴 수 있다.' }],
            '기본도형': [{ code: '9수03-01', content: '점, 선, 면의 관계를 이해하고, 다양한 기본 도형을 관찰하여 문제를 해결할 수 있다.' }, { code: '9수03-02', content: '각의 개념을 이해하고, 평행선의 성질을 활용하여 문제를 해결할 수 있다.' }],
            '작도와 합동': [{ code: '9수03-03', content: '삼각형의 작도와 합동의 원리를 이해하고, 이를 활용하여 문제를 해결할 수 있다.' }, { code: '9수03-04', content: '평행선과 엇각, 동위각의 성질을 이해하고, 이를 도형의 성질 증명에 활용할 수 있다.' }],
            '평면도형의 성질': [{ code: '9수03-05', content: '다각형의 성질을 이해하고, 내각과 외각의 크기를 구할 수 있다.' }, { code: '9수03-06', content: '원과 부채꼴의 성질을 이해하고, 호의 길이와 넓이를 계산할 수 있다.' }],
            '입체도형의 성질': [{ code: '9수03-07', content: '다양한 입체도형의 특징을 이해하고, 겉넓이와 부피를 구할 수 있다.' }, { code: '9수03-08', content: '회전체와 단면의 특징을 이해하고, 이를 활용하여 문제를 해결할 수 있다.' }],
            '대푯값': [{ code: '9수04-01', content: '도수분포표, 히스토그램, 도수분포다각형을 이해하고 작성할 수 있다.' }, { code: '9수04-02', content: '자료를 막대그래프, 원그래프 등으로 나타내고 해석할 수 있다.' }, { code: '9수04-03', content: '상대도수의 개념을 이해하고, 이를 활용하여 문제를 해결할 수 있다.' }, { code: '9수04-04', content: '자료를 수집하고 정리하여 경향성을 파악할 수 있다.' }],
          },
          '중2': {
            '유리수와 순환소수': [{ code: '9수01-06', content: '유리수와 순환소수의 관계를 이해하고, 이를 구분할 수 있다.' }],
            '식의 계산': [{ code: '9수02-08', content: '단항식과 다항식의 곱셈과 나눗셈을 할 수 있다.' }, { code: '9수02-09', content: '다항식의 덧셈과 뺄셈의 원리를 이해하고 계산할 수 있다.' }, { code: '9수02-10', content: '등식의 성질을 이해하고, 일차방정식의 풀이에 적용할 수 있다.' }],
            '일차부등식': [{ code: '9수02-11', content: '일차부등식의 의미와 풀이 방법을 이해하고, 수직선에 나타낼 수 있다.' }, { code: '9수02-12', content: '연립일차부등식을 풀고, 해를 수직선 위에 나타낼 수 있다.' }],
            '연립일차방정식': [{ code: '9수02-13', content: '연립일차방정식의 해를 구할 수 있고, 이를 활용하여 문제를 해결할 수 있다.' }],
            '일차함수와 그 그래프': [{ code: '9수02-14', content: '일차함수의 의미를 이해하고, 그 그래프를 그릴 수 있다.' }, { code: '9수02-15', content: '일차함수의 그래프의 기울기와 y절편의 의미를 이해하고, 그래프의 성질을 설명할 수 있다.' }, { code: '9수02-16', content: '일차함수의 그래프의 평행이동과 대칭이동을 이해하고, 그래프를 그릴 수 있다.' }],
            '일차함수와 일차방정식의 관계': [{ code: '9수02-17', content: '일차함수와 일차방정식의 관계를 이해하고, 그래프를 활용하여 문제를 해결할 수 있다.' }, { code: '9수02-18', content: '연립일차방정식의 해를 일차함수의 그래프를 이용하여 구할 수 있다.' }],
            '삼각형과 사각형의 성질': [{ code: '9수03-09', content: '삼각형의 내각과 외각의 성질을 이해하고, 이를 활용하여 문제를 해결할 수 있다.' }, { code: '9수03-10', content: '이등변삼각형의 성질을 이해하고, 이를 증명할 수 있다.' }, { code: '9수03-11', content: '직각삼각형의 합동조건을 이해하고, 이를 활용하여 문제를 해결할 수 있다.' }],
            '도형의 닮음': [{ code: '9수03-12', content: '도형의 닮음의 개념을 이해하고, 닮음비를 구할 수 있다.' }, { code: '9수03-13', content: '삼각형의 닮음조건을 이해하고, 이를 활용하여 문제를 해결할 수 있다.' }, { code: '9수03-14', content: '피타고라스 정리를 이해하고, 이를 증명할 수 있다.' }],
            '피타고라스 정리': [{ code: '9수03-15', content: '피타고라스 정리를 이해하고, 이를 증명할 수 있다.' }],
            '경우의 수와 확률': [{ code: '9수04-05', content: '경우의 수의 개념을 이해하고, 합의 법칙과 곱의 법칙을 활용할 수 있다.' }, { code: '9수04-06', content: '확률의 개념과 기본 성질을 이해하고, 이를 활용하여 문제를 해결할 수 있다.' }],
          },
          '중3': {
            '제곱근과 실수': [{ code: '9수01-07', content: '제곱근의 의미를 이해하고, 제곱근을 구할 수 있다.' }, { code: '9수01-08', content: '무리수와 실수의 개념을 이해하고, 실수의 대소 관계를 비교할 수 있다.' }, { code: '9수01-09', content: '제곱근의 곱셈과 나눗셈을 할 수 있다.' }, { code: '9수01-10', content: '제곱근의 덧셈과 뺄셈을 할 수 있다.' }],
            '다항식의 곱셈과 인수분해': [{ code: '9수02-19', content: '이차식의 인수분해의 원리를 이해하고, 이를 활용하여 문제를 해결할 수 있다.' }, { code: '9수02-20', content: '이차방정식의 의미를 이해하고, 그 해를 구할 수 있다.' }],
            '이차함수와 그 그래프': [{ code: '9수02-21', content: '이차함수의 의미를 이해하고, 그 그래프를 그릴 수 있다.' }, { code: '9수02-22', content: '이차함수 $y=ax^2+bx+c$ 의 그래프의 성질을 이해하고, 이를 활용할 수 있다.' }],
            '삼각비': [{ code: '9수03-16', content: '삼각비의 뜻을 알고, 직각삼각형에서 삼각비의 값을 구할 수 있다.' }, { code: '9수03-17', content: '삼각비를 활용하여 실생활 문제를 해결할 수 있다.' }],
            '원의 성질': [{ code: '9수03-18', content: '원의 현과 접선의 성질을 이해하고, 이를 활용하여 문제를 해결할 수 있다.' }, { code: '9수03-19', content: '원주각의 성질을 이해하고, 원주각의 크기를 구할 수 있다.' }],
            '산포도': [{ code: '9수04-07', content: '대푯값의 의미를 이해하고, 평균, 중앙값, 최빈값을 구할 수 있다.' }, { code: '9수04-08', content: '산포도의 의미를 이해하고, 분산과 표준편차를 구할 수 있다.' }, { code: '9수04-09', content: '산점도와 상관관계를 이해하고, 이를 분석할 수 있다.' }],
          },
        };
        const allAchievements = Object.values(unitAchievements).flatMap(grade => Object.values(grade)).flat();
        
        // --- Helper Functions ---
        const getByteCount = (str) => new TextEncoder().encode(str).length;
        
        const showToast = (message, type = 'success') => {
            const toastContainer = document.getElementById('toast-container');
            const toastId = `toast-${Date.now()}`;
            const bgColor = type === 'error' ? 'bg-red-600' : 'bg-green-600';
            const toast = document.createElement('div');
            toast.id = toastId;
            toast.className = `px-4 py-3 rounded-md shadow-lg text-white ${bgColor} transition-all duration-500 transform translate-x-full`;
            toast.innerHTML = message;
            toastContainer.appendChild(toast);
            
            requestAnimationFrame(() => {
                toast.classList.remove('translate-x-full');
            });

            setTimeout(() => {
                toast.classList.add('translate-x-full');
                toast.addEventListener('transitionend', () => toast.remove());
            }, 3000);
        };

        const truncateBySentence = (text, maxBytes) => {
            if (getByteCount(text) <= maxBytes) return text;
            const sentences = text.match(/[^.!?]*[.!?]\s*/g) || [text];
            let truncatedText = '';
            let currentBytes = 0;
            for (const sentence of sentences) {
                const sentenceBytes = getByteCount(sentence);
                if (currentBytes + sentenceBytes > maxBytes) break;
                truncatedText += sentence;
                currentBytes += sentenceBytes;
            }
            if (truncatedText.length === 0 && text.length > 0) {
                const encoder = new TextEncoder();
                const decoder = new TextDecoder('utf-8', { fatal: true });
                let sliceIndex = maxBytes;
                while (sliceIndex > 0) {
                    try {
                        truncatedText = decoder.decode(encoder.encode(text).slice(0, sliceIndex));
                        break;
                    } catch (e) {
                        sliceIndex--;
                    }
                }
            }
            return truncatedText.trim();
        };

        // --- DOM Rendering Functions ---
        const renderApp = () => {
            renderStepper();
            renderStepContent();
            updateNavButtons();
        };

        const renderStepper = () => {
            const stepperContainer = document.getElementById('stepper');
            const steps = [
                { number: 1, title: '학년 및 학생 명단', icon: `<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M16 21v-2a4 4 0 0 0-4-4H6a4 4 0 0 0-4 4v2"/><circle cx="9" cy="7" r="4"/><path d="M22 21v-2a4 4 0 0 0-3-3.87"/><path d="M16 3.13a4 4 0 0 1 0 7.75"/></svg>` },
                { number: 2, title: '단원 선택', icon: `<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M4 19.5v-15A2.5 2.5 0 0 1 6.5 2H20v20H6.5a2.5 2.5 0 0 1 0-5H20"/><path d="m9 9.5 2 2 4-4"/></svg>` },
                { number: 3, title: '성취기준 배정', icon: `<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><rect width="18" height="18" x="3" y="3" rx="2"/><path d="m9 12 2 2 4-4"/></svg>` },
                { number: 4, title: '특기사항 생성', icon: `<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M15 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V7Z"/><path d="M14 2v4a2 2 0 0 0 2 2h4"/><path d="M10 9H8"/><path d="M16 13H8"/><path d="M16 17H8"/></svg>` },
            ];
            stepperContainer.innerHTML = `
                <div class="flex items-center justify-between">
                    ${steps.map(step => `
                        <div class="flex-1 min-w-0 flex flex-col items-center cursor-pointer" onclick="window.goToStep(${step.number})">
                            <div class="flex items-center justify-center w-12 h-12 rounded-full shadow-lg ${state.currentStep >= step.number ? 'bg-blue-600 text-white' : 'bg-gray-200 text-gray-600'} transition-colors duration-300">
                                ${step.icon}
                            </div>
                            <div class="mt-2 text-sm font-semibold transition-colors duration-300 ${state.currentStep === step.number ? 'text-blue-600' : 'text-gray-500'}">STEP ${step.number}</div>
                            <div class="mt-1 text-xs text-center transition-colors duration-300 ${state.currentStep === step.number ? 'text-gray-800 font-bold' : 'text-gray-500'}">${step.title}</div>
                        </div>
                    `).join('')}
                </div>
            `;
        };
        
        const renderStepContent = () => {
            document.querySelectorAll('.step-section').forEach(el => el.classList.remove('active'));
            const activeStepEl = document.getElementById(`step-${state.currentStep}`);
            if (activeStepEl) {
                activeStepEl.classList.add('active');
                switch(state.currentStep) {
                    case 1: renderStep1(); break;
                    case 2: renderStep2(); break;
                    case 3: renderStep3(); break;
                    case 4: renderStep4(); break;
                }
            }
        };

        const renderStep1 = () => {
            const container = document.getElementById('step-1');
            container.innerHTML = `
                <div class="space-y-6">
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">학년 선택</label>
                        <select id="grade-select" class="w-full p-3 border border-gray-300 rounded-md shadow-sm focus:border-blue-500 focus:ring focus:ring-blue-500 focus:ring-opacity-50 transition">
                            <option value="">학년을 선택하세요</option>
                            <option value="중1" ${state.selectedGrade === '중1' ? 'selected' : ''}>중1</option>
                            <option value="중2" ${state.selectedGrade === '중2' ? 'selected' : ''}>중2</option>
                            <option value="중3" ${state.selectedGrade === '중3' ? 'selected' : ''}>중3</option>
                        </select>
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">학생 명단 입력</label>
                        <textarea id="student-input" placeholder="김철수\n이영희\n박민수" class="w-full h-32 p-3 border border-gray-300 rounded-md shadow-sm focus:border-blue-500 focus:ring focus:ring-blue-500 focus:ring-opacity-50 transition">${state.studentInput}</textarea>
                        <div class="mt-3 grid grid-cols-1 sm:grid-cols-2 gap-3">
                            <button id="register-students-btn" class="w-full px-4 py-2 bg-blue-600 text-white rounded-md shadow-md hover:bg-blue-700 transition">명단 등록</button>
                            <button id="load-class-btn" class="w-full px-4 py-2 bg-gray-600 text-white rounded-md shadow-md hover:bg-gray-700 transition">반 불러오기</button>
                        </div>
                        <div class="border-t pt-3 mt-4">
                            <label class="text-sm text-gray-600 block mb-2">CSV 파일로 명단 관리</label>
                             <div class="flex items-center gap-3">
                                <input type="file" id="csv-upload" accept=".csv" class="hidden" />
                                <label for="csv-upload" class="flex-1 cursor-pointer px-4 py-2 text-center bg-green-600 text-white rounded-md shadow-md hover:bg-green-700 transition">CSV 파일 업로드</label>
                                <button id="download-template-btn" class="px-4 py-2 bg-purple-600 text-white rounded-md shadow-md hover:bg-purple-700 transition">양식 다운로드</button>
                            </div>
                        </div>
                    </div>
                    ${state.students.length > 0 ? `
                        <div class="bg-green-50 p-4 rounded-md shadow-sm">
                            <h3 class="font-medium text-green-800">등록된 학생 (${state.students.length}명)</h3>
                            <div class="mt-2 flex flex-wrap gap-2">
                                ${state.students.map(student => `<span class="px-2 py-1 bg-green-200 text-green-800 rounded-lg text-sm font-medium">${student.name}</span>`).join('')}
                            </div>
                        </div>
                    ` : ''}
                </div>
            `;
            document.getElementById('grade-select').addEventListener('change', (e) => { state.selectedGrade = e.target.value; });
            document.getElementById('student-input').addEventListener('input', (e) => { state.studentInput = e.target.value; });
            document.getElementById('register-students-btn').addEventListener('click', handleStudentInput);
            document.getElementById('load-class-btn').addEventListener('click', showLoadClassModal);
            document.getElementById('csv-upload').addEventListener('change', handleFileUpload);
            document.getElementById('download-template-btn').addEventListener('click', handleDownloadTemplate);
        };
        
        const renderStep2 = () => {
            const container = document.getElementById('step-2');
            if (!state.selectedGrade) {
                container.innerHTML = `<div class="text-center text-gray-500">1단계에서 학년을 먼저 선택해주세요.</div>`;
                return;
            }
            const units = Object.keys(unitAchievements[state.selectedGrade] || {});
            container.innerHTML = `
                <div class="space-y-6">
                    <div class="bg-indigo-50 p-4 rounded-md shadow-sm">
                        <h3 class="font-medium text-indigo-800">${state.selectedGrade} 수학 단원 목록</h3>
                        <p class="text-sm text-indigo-600 mt-1">작성할 특기사항에 해당하는 단원을 선택하세요. (다중 선택 가능)</p>
                    </div>
                    <div class="grid grid-cols-1 sm:grid-cols-2 md:grid-cols-3 gap-4">
                        ${units.map(unit => `
                            <button data-unit="${unit}" class="unit-btn p-4 rounded-lg text-left shadow-sm transition transform hover:scale-105 ${state.selectedUnits.includes(unit) ? 'bg-blue-600 text-white font-semibold ring-2 ring-blue-300' : 'bg-white border border-gray-300 text-gray-700'}">
                                ${unit}
                            </button>
                        `).join('')}
                    </div>
                </div>
            `;
            document.querySelectorAll('.unit-btn').forEach(btn => btn.addEventListener('click', () => toggleUnit(btn.dataset.unit)));
        };

        const renderStep3 = () => {
            const container = document.getElementById('step-3');
            if (state.students.length === 0 || state.selectedUnits.length === 0) {
                container.innerHTML = `<div class="text-center text-gray-500">1단계와 2단계를 먼저 완료해주세요.</div>`;
                return;
            }
            const achievementMap = new Map();
            state.selectedUnits.flatMap(unit => (unitAchievements[state.selectedGrade][unit] || []).map(ach => ({ ...ach, unit }))).forEach(ach => {
                if (!achievementMap.has(ach.code)) achievementMap.set(ach.code, ach);
            });
            const uniqueAchievements = Array.from(achievementMap.values());
            const getGlobalAchievementCount = (code) => Object.values(state.stagedStudentAchievements).reduce((count, achievements) => count + (achievements[code] || 0), 0);
            const calculatedMaxGlobalDuplication = Math.max(1, Math.ceil((state.students.length * state.achievementsPerStudent) / uniqueAchievements.length));

            container.innerHTML = `
                <div class="space-y-8">
                    <div class="bg-gray-100 p-6 rounded-xl shadow-inner border border-gray-200">
                        <h3 class="text-xl font-bold text-gray-800 mb-4">성취기준 배정 설정</h3>
                        <p class="text-sm text-gray-600 mb-4">자동 배정 시 학생당 개수에 맞춰 성취기준이 균등하게 배분됩니다.</p>
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                            <div>
                                <label for="achievements-per-student" class="block text-sm font-medium text-gray-700 mb-2">학생당 성취기준 개수</label>
                                <input id="achievements-per-student" type="number" min="1" value="${state.achievementsPerStudent}" class="w-full p-3 border border-gray-300 rounded-md shadow-sm focus:border-blue-500 focus:ring focus:ring-blue-500 focus:ring-opacity-50 transition" />
                            </div>
                        </div>
                        <div class="mt-6 text-center">
                            <button id="auto-assign-btn" class="w-full max-w-sm px-6 py-3 rounded-md shadow-md text-white transition transform flex items-center justify-center mx-auto gap-2 bg-indigo-600 hover:bg-indigo-700">
                                <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M22 11.08V12a10 10 0 1 1-5.93-9.14"/><polyline points="22 4 12 14.01 9 11.01"/></svg>
                                자동 배정
                            </button>
                        </div>
                    </div>
                    ${state.students.map(student => {
                        const studentCount = Object.keys(state.stagedStudentAchievements[student.id] || {}).length;
                        const hasAllotment = studentCount === state.achievementsPerStudent;
                        return `
                            <div class="p-6 bg-white rounded-xl shadow-md border border-gray-200">
                                <div class="flex items-center justify-between mb-4 pb-2 border-b">
                                    <h4 class="text-xl font-bold text-gray-800">${student.name}</h4>
                                    <span class="px-3 py-1 rounded-full text-sm font-semibold ${hasAllotment ? 'bg-green-100 text-green-700' : 'bg-yellow-100 text-yellow-700'}">선택: ${studentCount} / ${state.achievementsPerStudent}</span>
                                </div>
                                <div class="space-y-3">
                                    ${uniqueAchievements.map(achievement => {
                                        const isSelected = !!state.stagedStudentAchievements[student.id]?.[achievement.code];
                                        const globalCount = getGlobalAchievementCount(achievement.code);
                                        const isGloballyFull = globalCount >= calculatedMaxGlobalDuplication;
                                        const isStudentFull = studentCount >= state.achievementsPerStudent && !isSelected;
                                        const isDisabled = (isGloballyFull && !isSelected) || isStudentFull;
                                        return `
                                            <label class="flex items-center p-3 rounded-lg border transition cursor-pointer ${isSelected ? 'bg-blue-50 border-blue-400' : 'bg-gray-50 border-gray-200 hover:border-blue-300'} ${isDisabled ? 'opacity-50 cursor-not-allowed' : ''}">
                                                <input type="checkbox" data-student-id="${student.id}" data-code="${achievement.code}" ${isSelected ? 'checked' : ''} ${isDisabled ? 'disabled' : ''} class="achievement-checkbox form-checkbox h-5 w-5 rounded transition ${isSelected ? 'text-blue-600' : 'text-gray-400'}" />
                                                <p class="text-sm text-gray-800 flex-1 ml-4"><span class="font-semibold mr-2">[${achievement.code}]</span>${achievement.content}<span class="ml-2 px-2 py-1 text-xs font-semibold rounded-full bg-blue-200 text-blue-800">총 ${globalCount}회</span></p>
                                            </label>
                                        `;
                                    }).join('')}
                                </div>
                            </div>
                        `;
                    }).join('')}
                </div>
            `;
            document.getElementById('achievements-per-student').addEventListener('change', (e) => { state.achievementsPerStudent = parseInt(e.target.value) || 1; renderStep3(); });
            document.getElementById('auto-assign-btn').addEventListener('click', autoAssignAchievements);
            document.querySelectorAll('.achievement-checkbox').forEach(cb => cb.addEventListener('change', (e) => handleAchievementToggle(e.target.dataset.studentId, e.target.dataset.code)));
        };

        const renderStep4 = () => {
            const container = document.getElementById('step-4');
            container.innerHTML = `
                <div class="space-y-6">
                    <div class="p-4 rounded-md bg-blue-50 border border-blue-200 text-blue-800 flex items-center gap-4">
                        <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="12" r="10"/><line x1="12" y1="16" x2="12" y2="12"/><line x1="12" y1="8" x2="12.01" y2="8"/></svg>
                        <p class="text-sm">**반 저장하기**를 누르면, 현재까지의 모든 작업(학생 명단, 성취기준 등)이 브라우저에 저장됩니다. 나중에 **반 불러오기**를 통해 이어서 작업할 수 있습니다.</p>
                    </div>
                    <div class="text-center">
                        <button id="save-class-btn" class="w-full max-w-sm px-6 py-3 rounded-md shadow-md flex items-center justify-center gap-2 transition transform bg-teal-600 text-white hover:bg-teal-700 mx-auto">
                            <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M19 21H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h11l5 5v11a2 2 0 0 1-2 2z"/><polyline points="17 21 17 13 7 13 7 21"/><polyline points="7 3 7 8 15 8"/></svg>
                            반 저장하기
                        </button>
                    </div>
                    <div class="border-t pt-6 mt-6">
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-2">포함할 내용 (선택)</label>
                                <textarea id="guidelines-include" placeholder="예) 발표 능력이 뛰어남, 문제 해결에 창의적임" class="w-full h-32 p-3 border border-gray-300 rounded-md shadow-sm focus:border-blue-500 focus:ring focus:ring-blue-500 focus:ring-opacity-50 transition">${state.guidelines.include}</textarea>
                            </div>
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-2">제외할 내용 (선택)</label>
                                <textarea id="guidelines-exclude" placeholder="예) 특정 단원 이름 직접 언급 방지" class="w-full h-32 p-3 border border-gray-300 rounded-md shadow-sm focus:border-blue-500 focus:ring focus:ring-blue-500 focus:ring-opacity-50 transition">${state.guidelines.exclude}</textarea>
                            </div>
                        </div>
                        <div class="mt-6">
                            <label for="max-byte-count" class="block text-sm font-medium text-gray-700 mb-2">최대 바이트 수 (한글 1자=3바이트)</label>
                            <input id="max-byte-count" type="number" min="1" value="${state.maxByteCount}" class="w-full p-3 border border-gray-300 rounded-md shadow-sm focus:border-blue-500 focus:ring focus:ring-blue-500 focus:ring-opacity-50 transition" />
                        </div>
                        <div class="text-center pt-6 mt-6 border-t">
                            <button id="generate-records-btn" class="w-full max-w-sm px-6 py-3 rounded-md shadow-md flex items-center justify-center gap-2 transition transform bg-green-600 text-white hover:bg-green-700 disabled:opacity-50 disabled:cursor-wait">
                                <span id="generate-btn-icon">
                                    <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"/><polyline points="7 10 12 15 17 10"/><line x1="12" x2="12" y1="15" y2="3"/></svg>
                                </span>
                                <span id="generate-btn-text">특기사항 생성</span>
                            </button>
                        </div>
                    </div>
                    <div id="records-output" class="space-y-4 pt-6 mt-6 border-t">
                        <!-- Generated records will appear here -->
                    </div>
                </div>
            `;
            document.getElementById('save-class-btn').addEventListener('click', showSaveClassModal);
            document.getElementById('guidelines-include').addEventListener('input', (e) => { state.guidelines.include = e.target.value; });
            document.getElementById('guidelines-exclude').addEventListener('input', (e) => { state.guidelines.exclude = e.target.value; });
            document.getElementById('max-byte-count').addEventListener('input', (e) => { state.maxByteCount = parseInt(e.target.value) || 1; });
            document.getElementById('generate-records-btn').addEventListener('click', generateRecords);
            
            if (Object.keys(state.generatedRecords).length > 0) {
                 document.getElementById('records-output').innerHTML = renderRecordsOutput();
                 addRecordOutputListeners();
            }
        };
        
        const renderRecordsOutput = () => {
            return `
                <h4 class="text-2xl font-bold text-gray-900 mb-4">생성된 특기사항</h4>
                <div class="flex justify-end gap-2 mb-4">
                    <button id="download-excel-btn" class="px-4 py-2 bg-purple-600 text-white rounded-md shadow-md hover:bg-purple-700 transition flex items-center gap-2 text-sm">
                        <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M15 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V7Z"/><path d="M14 2v4a2 2 0 0 0 2 2h4"/><path d="M10 9H8"/><path d="M16 13H8"/><path d="M16 17H8"/></svg>
                        엑셀 파일로 다운로드 (.csv)
                    </button>
                </div>
                ${state.students.map(student => {
                    const record = state.generatedRecords[student.id] || '';
                    const byteCount = getByteCount(record);
                    return `
                        <div class="border rounded-lg p-4 shadow-sm bg-gray-50">
                            <div class="flex justify-between items-center mb-3">
                                <h4 class="font-medium text-lg">${student.name}</h4>
                                <div class="flex items-center gap-2">
                                    <div class="text-sm font-medium">바이트 수: <span class="byte-count font-bold ${byteCount > state.maxByteCount ? 'text-red-500' : 'text-green-600'}">${byteCount}</span> / ${state.maxByteCount}</div>
                                    <button data-student-id="${student.id}" class="restore-individual-btn px-3 py-1 bg-gray-500 text-white rounded-md hover:bg-gray-600 transition flex items-center gap-1 text-xs">
                                        <svg xmlns="http://www.w3.org/2000/svg" width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M3 12a9 9 0 1 0 9-9 9.75 9.75 0 0 0-6.74 2.74L3 8"/><path d="M3 3v5h5"/></svg>
                                        복구
                                    </button>
                                </div>
                            </div>
                            ${Object.keys(state.stagedStudentAchievements[student.id] || {}).length > 0 ? `
                                <div class="space-y-3">
                                    <div class="text-xs text-gray-500 flex flex-wrap gap-1 mb-2">
                                        ${Object.keys(state.stagedStudentAchievements[student.id] || {}).map(code => `<span class="bg-gray-200 px-2 py-1 rounded font-mono">${code}</span>`).join('')}
                                    </div>
                                    <textarea id="textarea-${student.id}" class="record-textarea w-full h-40 p-3 bg-white rounded-md border text-gray-800 resize-y focus:outline-none focus:ring-2 focus:ring-blue-500 transition-colors" data-student-id="${student.id}">${record}</textarea>
                                </div>
                            ` : `<p class="text-gray-500 italic">선택된 성취기준이 없어 특기사항이 생성되지 않았습니다.</p>`}
                        </div>
                    `;
                }).join('')}
            `;
        };
        
        const addRecordOutputListeners = () => {
            document.getElementById('download-excel-btn')?.addEventListener('click', handleDownloadExcel);
            document.querySelectorAll('.restore-individual-btn').forEach(btn => btn.addEventListener('click', (e) => handleRestoreIndividual(e.currentTarget.dataset.studentId)));
            document.querySelectorAll('.record-textarea').forEach(ta => ta.addEventListener('input', (e) => {
                const studentId = e.target.dataset.studentId;
                state.generatedRecords[studentId] = e.target.value;
                const byteCountEl = e.target.closest('.border').querySelector('.byte-count');
                const newByteCount = getByteCount(e.target.value);
                byteCountEl.textContent = `${newByteCount}`;
                byteCountEl.parentElement.classList.toggle('text-red-500', newByteCount > state.maxByteCount);
                byteCountEl.parentElement.classList.toggle('text-green-600', newByteCount <= state.maxByteCount);
            }));
        };

        const updateNavButtons = () => {
            const prevBtn = document.getElementById('prev-step-btn');
            const nextBtn = document.getElementById('next-step-btn');
            prevBtn.disabled = state.currentStep === 1;
            nextBtn.disabled = state.currentStep === 4;
        };

        // --- Event Handlers & Logic ---
        const handleStudentInput = () => {
            if (!state.selectedGrade) {
                showToast('먼저 학년을 선택해주세요.', 'error');
                return;
            }
            const studentList = state.studentInput.split('\n').map(line => line.trim()).filter(line => line).map(name => ({ id: crypto.randomUUID(), name }));
            if (studentList.length === 0) {
                showToast('학생 명단을 입력해주세요.', 'error');
                return;
            }
            state.students = studentList;
            showToast(`${studentList.length}명의 학생이 등록되었습니다.`);
            nextStep();
        };

        const handleFileUpload = async (event) => {
            const file = event.target.files[0];
            if (!file) return;
            if (!state.selectedGrade) {
                showToast('먼저 학년을 선택해주세요.', 'error');
                event.target.value = '';
                return;
            }
            if (!file.name.endsWith('.csv')) {
                showToast('CSV 파일만 지원됩니다.', 'error');
                return;
            }
            const text = await file.text();
            const studentList = text.split(/[\n\r]+/).map(line => line.trim()).filter(line => line).map(name => ({ id: crypto.randomUUID(), name }));
            
            state.studentInput = studentList.map(s => s.name).join('\n');
            state.students = studentList;
            showToast('CSV 파일에서 학생 명단이 성공적으로 등록되었습니다.');
            nextStep();
        };
        
        const toggleUnit = (unit) => {
            const index = state.selectedUnits.indexOf(unit);
            if (index > -1) {
                state.selectedUnits.splice(index, 1);
            } else {
                state.selectedUnits.push(unit);
            }
            renderStep2();
        };

        const handleAchievementToggle = (studentId, code) => {
            const studentSelections = state.stagedStudentAchievements[studentId] || {};
            if (studentSelections[code]) {
                delete studentSelections[code];
            } else {
                if (Object.keys(studentSelections).length < state.achievementsPerStudent) {
                    studentSelections[code] = 1;
                } else {
                    showToast(`학생당 최대 ${state.achievementsPerStudent}개의 성취기준만 선택할 수 있습니다.`, 'error');
                }
            }
            state.stagedStudentAchievements[studentId] = studentSelections;
            renderStep3();
        };
        
        const autoAssignAchievements = () => {
            state.stagedStudentAchievements = {};
            const availableAchievements = state.selectedUnits.flatMap(unit => unitAchievements[state.selectedGrade][unit] || []).map(ach => ach.code);
            if (availableAchievements.length === 0) {
                showToast('선택된 단원에 해당하는 성취기준이 없습니다.', 'error');
                return;
            }
            
            let achievementIndex = 0;
            state.students.forEach(student => {
                state.stagedStudentAchievements[student.id] = {};
                for (let i = 0; i < state.achievementsPerStudent; i++) {
                    const code = availableAchievements[achievementIndex % availableAchievements.length];
                    state.stagedStudentAchievements[student.id][code] = 1;
                    achievementIndex++;
                }
            });
            showToast('성취기준이 자동으로 배정되었습니다.');
            renderStep3();
        };

        const generateRecords = async () => {
            if (state.isLoading) return;
            const studentsWithAchievements = state.students.filter(s => Object.keys(state.stagedStudentAchievements[s.id] || {}).length > 0);
            if (studentsWithAchievements.length === 0) {
                showToast('특기사항을 생성할 학생이 없습니다. 3단계에서 성취기준을 배정해주세요.', 'error');
                return;
            }

            state.isLoading = true;
            updateGenerateButton(true, '생성 준비 중...');
            
            const fixedInclude = [
                '문장 끝은 명사형 어미("-함", "-음", "-됨", "-임")로 종결',
                '구체적 관찰 사실과 행동 특성을 서술한 후, 평가와 전망을 제시하는 구조로 작성',
                '학업역량(자기주도적 학습태도, 탐구심, 문제해결력 등), 인성(성실성, 책임감, 배려심 등), 사회성(협력, 의사소통능력 등) 등 다양한 영역을 수학 교과와 관련하여 구체적으로 서술',
                '긍정적 변화와 성장 과정을 강조하여 학생의 개별적 특성과 장점이 드러나도록 작성',
                '수학적 역량(문제해결, 추론, 의사소통, 창의융합 등)과 관련된 내용을 포함',
                '창의적, 논리적, 엄밀성, 정확함 등의 수학적 소양을 반영',
                ',.;\' 등의 문장부호를 적절하게 사용',
                '문법적으로 완벽하고 자연스러운 한국어 문장을 구사할 것. 특히, 명사 뒤에 오는 조사(은, 는, 이, 가, 을, 를, 의 등)를 정확하게 사용하여 문맥에 맞게 연결할 것. (예: "정확성 돋보임" -> "정확성이 돋보임", "다항식 덧셈과" -> "다항식의 덧셈과")',
            ];
            const fixedExclude = [
                '학생 이름이 주어로 사용되지 않도록 함 (예: "OOO 학생은")',
                '평가, 대회, 학생 등의 단어 사용 금지',
                '@#$%^&* 등의 특수기호 사용 절대 금지',
                '이해함. 수행함. 관찰함. 등과 같이 주어가 학생인 것처럼 보이는 서술 방식 금지',
                '성취기준 코드나 내용은 언급하지 말기',
                '기여함이 돋보임, 비교함이 관찰됨과 같은 이중 서술은 사용하지 말 것',
            ];
            
            let processedCount = 0;
            const outputContainer = document.getElementById('records-output');
            outputContainer.innerHTML = renderRecordsOutput();
            addRecordOutputListeners();

            for (const student of studentsWithAchievements) {
                processedCount++;
                updateGenerateButton(true, `${student.name} (${processedCount}/${studentsWithAchievements.length}) 생성 중...`);
                
                const textarea = document.getElementById(`textarea-${student.id}`);
                if (textarea) textarea.value = '';
                state.generatedRecords[student.id] = '';

                const achievementDetails = Object.keys(state.stagedStudentAchievements[student.id]).map(code => {
                    return allAchievements.find(a => a.code === code)?.content || code;
                }).join('; ');

                const prompt = `중학교 ${state.selectedGrade} 수학 과목의 세부능력 및 특기사항을 작성해줘. 다음 성취기준을 활용해서 문장을 자연스럽게 연결해줘.
**선택된 성취기준:** ${achievementDetails}
**작성 지침:** 다음 내용을 반드시 포함해. ${fixedInclude.join('\n')} ${state.guidelines.include ? `\n- 사용자 입력:\n${state.guidelines.include}` : ''}
다음 내용은 절대 포함하지 말아줘. ${fixedExclude.join('\n')} ${state.guidelines.exclude ? `\n- 사용자 입력:\n${state.guidelines.exclude}` : ''}
특기사항은 한 문단으로 작성하고, 최대 ${state.maxByteCount} 바이트에 가깝게, 하지만 절대 넘지 않도록 풍부하고 상세하게 작성해줘.`;

                try {
                    const chatHistory = [{ role: "user", parts: [{ text: prompt }] }];
                    const payload = { contents: chatHistory };
                    const apiKey = "";
                    const apiUrl = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-05-20:generateContent?key=${apiKey}`;
                    
                    const response = await fetch(apiUrl, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify(payload)
                    });
                    
                    if (!response.ok) throw new Error(`API Error: ${response.status}`);
                    
                    const result = await response.json();
                    const text = result.candidates?.[0]?.content?.parts?.[0]?.text || '생성 실패: 응답 없음';
                    
                    const final_text = truncateBySentence(text, state.maxByteCount);
                    state.generatedRecords[student.id] = final_text;
                    state.originalRecords[student.id] = final_text;
                    
                    if (textarea) {
                        textarea.value = final_text;
                        const byteCountEl = textarea.closest('.border').querySelector('.byte-count');
                        byteCountEl.textContent = getByteCount(final_text);
                    }

                } catch (error) {
                    console.error(`API Error for ${student.name}:`, error);
                    state.generatedRecords[student.id] = '생성 실패: 오류 발생';
                    if (textarea) textarea.value = '생성 실패: 오류 발생';
                }
            }
            state.isLoading = false;
            updateGenerateButton(false, '특기사항 생성');
            showToast('특기사항 생성이 완료되었습니다.');
        };
        
        const updateGenerateButton = (isLoading, text) => {
            const btn = document.getElementById('generate-records-btn');
            const btnText = document.getElementById('generate-btn-text');
            const btnIcon = document.getElementById('generate-btn-icon');
            if (!btn || !btnText || !btnIcon) return;
            
            btn.disabled = isLoading;
            btnText.textContent = text;
            if (isLoading) {
                btn.classList.add('bg-gray-400', 'cursor-wait');
                btn.classList.remove('bg-green-600', 'hover:bg-green-700');
                btnIcon.innerHTML = `<div class="loader"></div>`;
            } else {
                btn.classList.remove('bg-gray-400', 'cursor-wait');
                btn.classList.add('bg-green-600', 'hover:bg-green-700');
                btnIcon.innerHTML = `<svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"/><polyline points="7 10 12 15 17 10"/><line x1="12" x2="12" y1="15" y2="3"/></svg>`;
            }
        };

        const handleDownloadExcel = () => {
            if (Object.keys(state.generatedRecords).length === 0) {
                showToast('다운로드할 데이터가 없습니다.', 'error');
                return;
            }
            let csvContent = "data:text/csv;charset=utf-8,\uFEFF"; // BOM for Excel
            csvContent += "이름,세부능력 및 특기사항\n";
            state.students.forEach(student => {
                const record = state.generatedRecords[student.id] || '';
                const row = `"${student.name}","${record.replace(/"/g, '""')}"`;
                csvContent += row + "\n";
            });
            const encodedUri = encodeURI(csvContent);
            const link = document.createElement("a");
            link.setAttribute("href", encodedUri);
            link.setAttribute("download", "세특_결과.csv");
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
            showToast('CSV 파일 다운로드가 시작됩니다.');
        };
        
        const handleDownloadTemplate = () => {
            let csvContent = "data:text/csv;charset=utf-8,\uFEFF";
            csvContent += "이름\n";
            csvContent += "김민준\n이서연\n박도윤\n";
            const encodedUri = encodeURI(csvContent);
            const link = document.createElement("a");
            link.setAttribute("href", encodedUri);
            link.setAttribute("download", "학생명단_양식.csv");
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
        };

        const handleRestoreIndividual = (studentId) => {
            const original = state.originalRecords[studentId];
            if (original) {
                state.generatedRecords[studentId] = original;
                const textarea = document.getElementById(`textarea-${studentId}`);
                if (textarea) {
                    textarea.value = original;
                    const byteCountEl = textarea.closest('.border').querySelector('.byte-count');
                    const newByteCount = getByteCount(original);
                    byteCountEl.textContent = `${newByteCount}`;
                    byteCountEl.parentElement.classList.toggle('text-red-500', newByteCount > state.maxByteCount);
                    byteCountEl.parentElement.classList.toggle('text-green-600', newByteCount <= state.maxByteCount);
                }
                showToast(`${state.students.find(s=>s.id === studentId).name} 학생의 특기사항이 복구되었습니다.`);
            } else {
                showToast('복구할 원본 데이터가 없습니다.', 'error');
            }
        };

        // --- Local Storage & Modal Logic ---
        const getSavedClasses = () => {
            const classes = [];
            for (let i = 0; i < localStorage.length; i++) {
                const key = localStorage.key(i);
                if (key.startsWith('setk-class-')) {
                    classes.push(key.replace('setk-class-', ''));
                }
            }
            return classes;
        };
        
        const saveClass = (className) => {
            if (!className) {
                showToast('반 이름을 입력해주세요.', 'error');
                return;
            }
            localStorage.setItem(`setk-class-${className}`, JSON.stringify(state));
            showToast(`'${className}' 반의 정보가 저장되었습니다.`);
            closeModal();
        };
        
        const loadClass = (className) => {
            const savedState = localStorage.getItem(`setk-class-${className}`);
            if (savedState) {
                state = JSON.parse(savedState);
                showToast(`'${className}' 반의 정보를 불러왔습니다.`);
                closeModal();
                renderApp();
            } else {
                showToast('저장된 데이터를 불러오는 데 실패했습니다.', 'error');
            }
        };
        
        const deleteClass = (className) => {
            localStorage.removeItem(`setk-class-${className}`);
            showToast(`'${className}' 반의 정보가 삭제되었습니다.`);
            showLoadClassModal(); // Refresh the modal list
        };
        
        const closeModal = () => {
            const modalContainer = document.getElementById('modal-container');
            modalContainer.innerHTML = '';
        };
        
        const showSaveClassModal = () => {
            const modalContainer = document.getElementById('modal-container');
            const defaultName = `${state.selectedGrade || '반'} (${new Date().toLocaleDateString()})`;
            modalContainer.innerHTML = `
                <div class="modal-overlay" onclick="closeModal()">
                    <div class="bg-white rounded-lg shadow-2xl p-8 w-full max-w-md" onclick="event.stopPropagation()">
                        <h3 class="text-2xl font-bold mb-4">반 저장하기</h3>
                        <p class="text-gray-600 mb-6">현재까지의 모든 작업 내용을 저장합니다. 반 이름을 입력해주세요.</p>
                        <input id="class-name-input" type="text" value="${defaultName}" class="w-full p-3 border border-gray-300 rounded-md shadow-sm mb-6">
                        <div class="flex justify-end gap-3">
                            <button id="cancel-save-btn" class="px-4 py-2 bg-gray-200 text-gray-800 rounded-md hover:bg-gray-300">취소</button>
                            <button id="confirm-save-btn" class="px-4 py-2 bg-blue-600 text-white rounded-md hover:bg-blue-700">저장</button>
                        </div>
                    </div>
                </div>
            `;
            document.getElementById('confirm-save-btn').addEventListener('click', () => saveClass(document.getElementById('class-name-input').value));
            document.getElementById('cancel-save-btn').addEventListener('click', closeModal);
        };
        
        const showLoadClassModal = () => {
            const modalContainer = document.getElementById('modal-container');
            const savedClasses = getSavedClasses();
            
            modalContainer.innerHTML = `
                <div class="modal-overlay" onclick="closeModal()">
                    <div class="bg-white rounded-lg shadow-2xl p-8 w-full max-w-lg" onclick="event.stopPropagation()">
                        <h3 class="text-2xl font-bold mb-4">반 불러오기</h3>
                        <div class="space-y-3 max-h-96 overflow-y-auto">
                            ${savedClasses.length > 0 ? savedClasses.map(name => `
                                <div class="flex items-center justify-between p-3 bg-gray-100 rounded-md">
                                    <span class="font-medium text-gray-800">${name}</span>
                                    <div class="flex gap-2">
                                        <button class="load-btn px-3 py-1 text-sm bg-blue-600 text-white rounded hover:bg-blue-700" data-name="${name}">불러오기</button>
                                        <button class="delete-btn px-3 py-1 text-sm bg-red-600 text-white rounded hover:bg-red-700" data-name="${name}">삭제</button>
                                    </div>
                                </div>
                            `).join('') : '<p class="text-gray-500 text-center">저장된 반이 없습니다.</p>'}
                        </div>
                        <div class="flex justify-end mt-6">
                            <button id="cancel-load-btn" class="px-4 py-2 bg-gray-200 text-gray-800 rounded-md hover:bg-gray-300">닫기</button>
                        </div>
                    </div>
                </div>
            `;
            document.querySelectorAll('.load-btn').forEach(btn => btn.addEventListener('click', (e) => loadClass(e.target.dataset.name)));
            document.querySelectorAll('.delete-btn').forEach(btn => btn.addEventListener('click', (e) => deleteClass(e.target.dataset.name)));
            document.getElementById('cancel-load-btn').addEventListener('click', closeModal);
        };

        // --- Navigation ---
        window.goToStep = (stepNumber) => {
            if (state.currentStep === stepNumber) return;
            // Add validation checks before allowing step change
            if (stepNumber > 1 && !state.selectedGrade) {
                showToast('1단계: 학년을 먼저 선택해주세요.', 'error');
                return;
            }
            if (stepNumber > 1 && state.students.length === 0) {
                showToast('1단계: 학생 명단을 먼저 등록해주세요.', 'error');
                return;
            }
             if (stepNumber > 2 && state.selectedUnits.length === 0) {
                showToast('2단계: 단원을 하나 이상 선택해주세요.', 'error');
                return;
            }
            state.currentStep = stepNumber;
            renderApp();
        };
        const nextStep = () => {
            if (state.currentStep < 4) {
                // Use goToStep to leverage its validation logic
                window.goToStep(state.currentStep + 1);
            }
        };
        const prevStep = () => {
            if (state.currentStep > 1) {
                state.currentStep--;
                renderApp();
            }
        };
        
        // --- App Initialization ---
        function initializeAppLogic() {
            document.getElementById('prev-step-btn').addEventListener('click', prevStep);
            document.getElementById('next-step-btn').addEventListener('click', nextStep);
            renderApp();
        }

        loginBtn.addEventListener('click', signInWithGoogle);

    </script>
</body>
</html>

